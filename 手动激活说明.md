# 手动激活会员 - 快速指南

## 问题现状

使用 100% 优惠码的 Payhip 订单可能无法自动激活，因为 Payhip 不会为免费订单触发 Webhook。

## 解决方案

我已经添加了**手动激活功能**，管理员可以直接输入订单信息来激活会员。

## 使用步骤

### 1. 访问支付设置页面

登录管理后台，访问：`/admin/payment_settings`

### 2. 查看 Payhip 后台订单

在 Payhip 的 Dashboard → Customers 页面，可以看到所有订单信息，包括：
- 订单 ID (Order ID)：例如 `LWRwLk8Pza`
- 邮箱：购买时填写的邮箱
- 用户名：需要在支付链接中传递

### 3. 手动激活会员

在支付设置页面的"调试 & 手动工具"部分：

1. **填写用户名**：输入需要激活会员的用户名
2. **填写订单 ID**：从 Payhip 后台复制订单 ID
3. **填写邮箱**（可选）：购买时使用的邮箱
4. 点击"激活会员"按钮

### 示例

根据您提供的 Payhip 订单列表：

| 用户名 | 订单 ID | 邮箱 |
|--------|---------|------|
| （需要在支付时传递） | LWRwLk8Pza | sjjshsheueue |
| （需要在支付时传递） | KzyO74ekGX | isisjsjsa@gmail.com |
| （需要在支付时传递） | 2GZxenZ6zp | 3221226810@outlook.com |
| （需要在支付时传递） | yBbje3lvBD | 3425354803@qq.com |
| （需要在支付时传递） | LWRwL28vza | 2198644948@qq.com |

**注意**：由于支付链接应该包含 `?checkout_custom_variables[username]=用户名`，如果用户在支付时没有正确传递用户名，您需要通过其他方式（如邮箱）确认用户身份。

## 额外功能

### 测试 Payhip API

在同一页面可以点击"测试 Payhip API"按钮，查看：
- API 连接是否正常
- 返回的订单数据结构
- 帮助调试自动查询功能

这需要先配置 Payhip API Key（在 Payhip 后台 Settings → API 获取）。

## 订单来源标识

所有订单都会在列表中显示来源：
- **Webhook**：通过 Payhip Webhook 自动创建
- **API**：通过 API 查询自动创建
- **手动**：管理员手动激活创建
- **未知**：旧数据或其他来源

## 防重复保护

系统会自动检查订单 ID，防止同一订单被重复处理，即使多次点击激活按钮也不会重复增加会员时长。

## 当前已知问题

1. **Payhip 不发送 Webhook**：使用 100% 优惠码时，Payhip 确实不会触发 Webhook
2. **Payhip API 可能不返回数据**：API 端点和数据格式可能与预期不符，需要测试确认
3. **用户名丢失**：如果支付链接没有包含 `checkout_custom_variables[username]`，订单无法关联到用户

## 建议

对于测试用的优惠码订单，最简单的方法是：

1. 记录每次测试的用户名
2. 从 Payhip 后台获取订单 ID
3. 使用手动激活功能立即激活会员

这样可以绕过所有自动检测的问题，确保测试流程顺畅。

## 技术细节

- 手动激活会创建 `source: 'manual_admin'` 的订单记录
- 会记录操作的管理员用户名（`processed_by` 字段）
- 会员时长会基于当前到期时间累加 30 天
- 如果用户尚未成为 Pro 会员，会从当前时间开始计算 30 天
