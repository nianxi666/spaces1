<!DOCTYPE html>
<html lang="zh-CN" class="scroll-smooth">
<head>
    <title>{% block title %}ÂçóÁìúAI{% endblock %}</title>
    <meta name="baidu-site-verification" content="codeva-woywxjPQ5o" />
    <meta name="baidu_union_verify" content="bda8fde006c264232a8c8db61b7c51ef">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    {% block meta_description %}
    <meta name="description" content="ÂçóÁìúAIÊòØ‰∏Ä‰∏™ÂÖÖÊª°ÂàõÊÑèÁöÑAIÈ°πÁõÆÁ§æÂå∫ÔºåÊé¢Á¥¢ÊúÄÊñ∞„ÄÅÊúÄÊúâË∂£ÁöÑAIÂ∫îÁî®ÂíåÂ∑•ÂÖ∑„ÄÇ">
    {% endblock %}
    <link rel="canonical" href="{{ canonical_url or request.url }}" />
    <link rel="icon" type="image/png" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéÉ</text></svg>">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Alpine.js for interactions -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>

    <!-- Google Fonts (Inter) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- CodeMirror -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/javascript/javascript.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        pumpkin: {
                            50: '#fff7ed',
                            100: '#ffedd5',
                            200: '#fed7aa',
                            300: '#fdba74',
                            400: '#fb923c',
                            500: '#ff7518', // Brand Color
                            600: '#ea580c',
                            700: '#c2410c',
                            800: '#9a3412',
                            900: '#7c2d12',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
                    },
                    backdropBlur: {
                        xs: '2px',
                    }
                }
            }
        }
    </script>

    <style type="text/tailwindcss">
        @layer utilities {
            .glass {
                @apply bg-white/70 backdrop-blur-xl border border-white/20 shadow-sm;
            }
            .glass-dark {
                @apply bg-black/70 backdrop-blur-xl border border-white/10 shadow-sm;
            }
            .glass-card {
                @apply bg-white/60 backdrop-blur-lg border border-white/40 shadow-lg;
            }
            .hide-scrollbar::-webkit-scrollbar {
                display: none;
            }
            .hide-scrollbar {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            .tap-highlight-transparent {
                -webkit-tap-highlight-color: transparent;
            }
        }

        /* Custom Animations */
        @keyframes fade-in-up {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in-up {
            animation: fade-in-up 0.6s ease-out forwards;
        }

        .delay-100 { animation-delay: 100ms; }
        .delay-200 { animation-delay: 200ms; }
        .delay-300 { animation-delay: 300ms; }

        body {
            @apply bg-gray-50 text-gray-900;
        }
    </style>
</head>
<body class="antialiased selection:bg-pumpkin-500 selection:text-white" x-data="{ mobileMenuOpen: false, scrolled: false }" @scroll.window="scrolled = (window.pageYOffset > 20)">

    <!-- Desktop Header -->
    <header :class="{ 'bg-white/80 border-b border-gray-200/50 shadow-sm': scrolled, 'bg-transparent': !scrolled }"
            class="fixed top-0 w-full z-50 transition-all duration-300 backdrop-blur-xl">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo -->
                <div class="flex-shrink-0 flex items-center">
                    <a href="{{ url_for('main.index') }}" class="flex items-center gap-2 group">
                        <div class="relative w-8 h-8 flex items-center justify-center transition-transform duration-500 group-hover:rotate-12">
                             <svg class="w-full h-full text-pumpkin-500" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-5-9c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm10 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm-5 4c2.5 0 4.5-1.5 5.5-3.5H4.5c1 2 2.5 3.5 5.5 3.5z"/>
                            </svg>
                        </div>
                        <span class="font-bold text-xl tracking-tight text-gray-900">ÂçóÁìúAI</span>
                    </a>
                </div>

                <!-- Desktop Nav -->
                <nav class="hidden md:flex space-x-1">
                    {% set nav_items = [
                        ('main.index', 'Êé¢Á¥¢', 'home'),
                        ('main.article_list', 'ÊñáÁ´†', 'book'),
                    ] %}

                    {% for endpoint, label, icon in nav_items %}
                    <a href="{{ url_for(endpoint) }}"
                       class="px-4 py-2 rounded-full text-sm font-medium transition-all duration-200
                              {{ 'bg-gray-100 text-pumpkin-600' if request.endpoint == endpoint else 'text-gray-600 hover:bg-gray-50 hover:text-gray-900' }}">
                        {{ label }}
                    </a>
                    {% endfor %}

                    <!-- Drive Button -->
                    <a href="{{ url_for('results.modal_drive') }}"
                       class="ml-2 px-4 py-2 rounded-full text-sm font-medium text-white bg-gradient-to-r from-pumpkin-500 to-rose-500 hover:from-pumpkin-600 hover:to-rose-600 shadow-md hover:shadow-lg transition-all duration-300 transform hover:-translate-y-0.5 flex items-center gap-1.5">
                        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 15v4c0 1.1.9 2 2 2h14a2 2 0 0 0 2-2v-4M17 9l-5 5-5-5M12 12.8V2.5"/></svg>
                        <span>ÁΩëÁõò</span>
                    </a>

                    {% if session.get('logged_in') %}
                        <a href="{{ url_for('main.cloud_terminal') }}"
                           class="ml-2 px-4 py-2 rounded-full text-sm font-medium text-gray-700 bg-white border border-gray-200 hover:bg-gray-50 hover:border-gray-300 transition-all flex items-center gap-1.5">
                            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 17 10 11 4 5"></polyline><line x1="12" y1="19" x2="20" y2="19"></line></svg>
                            <span>‰∫ëÁªàÁ´Ø</span>
                        </a>
                    {% endif %}
                </nav>

                <!-- Right Side (Auth) -->
                <div class="hidden md:flex items-center space-x-3">
                    {% if settings.get('chat_enabled', True) %}
                    <a href="{{ url_for('main.chat') }}" class="relative p-2 text-gray-500 hover:text-pumpkin-600 transition-colors" title="ËÅäÂ§©ÂÆ§">
                        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                        <span class="chat-unread-badge absolute top-1 right-1 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white hidden"></span>
                    </a>
                    {% endif %}

                    {% if session.is_admin %}
                        <a href="{{ url_for('admin.admin_panel') }}" class="p-2 text-gray-500 hover:text-pumpkin-600 transition-colors" title="ÁÆ°ÁêÜÈù¢Êùø">
                             <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                        </a>
                    {% endif %}

                    {% if session.get('logged_in') %}
                    <div class="relative" x-data="{ open: false }">
                        <button @click="open = !open" @click.away="open = false" class="flex items-center gap-2 focus:outline-none">
                            <img src="{{ session.user_avatar or url_for('static', filename='avatars/default.png') }}" class="w-9 h-9 rounded-full border border-gray-200 object-cover ring-2 ring-transparent hover:ring-pumpkin-200 transition-all">
                        </button>
                        <!-- Dropdown -->
                        <div x-show="open"
                             x-transition:enter="transition ease-out duration-100"
                             x-transition:enter-start="transform opacity-0 scale-95"
                             x-transition:enter-end="transform opacity-100 scale-100"
                             x-transition:leave="transition ease-in duration-75"
                             x-transition:leave-start="transform opacity-100 scale-100"
                             x-transition:leave-end="transform opacity-0 scale-95"
                             class="absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-lg border border-gray-100 py-1 z-50 origin-top-right">
                            <a href="{{ url_for('main.profile') }}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">‰∏™‰∫∫ËµÑÊñô</a>
                            {% if session.is_admin %}
                            <a href="{{ url_for('main.settings') }}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">ËÆæÁΩÆ</a>
                            {% endif %}
                            <div class="border-t border-gray-100 my-1"></div>
                            <a href="{{ url_for('auth.logout') }}" class="block px-4 py-2 text-sm text-red-600 hover:bg-red-50">ÈÄÄÂá∫ÁôªÂΩï</a>
                        </div>
                    </div>
                    {% else %}
                        <a href="{{ url_for('auth.login') }}" class="text-sm font-medium text-gray-600 hover:text-gray-900 transition-colors">ÁôªÂΩï</a>
                        <a href="{{ url_for('auth.register') }}" class="px-4 py-2 rounded-full text-sm font-semibold text-white bg-gray-900 hover:bg-black transition-all shadow-md hover:shadow-lg transform hover:-translate-y-0.5">Ê≥®ÂÜå</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="pt-20 pb-28 md:pb-12 min-h-screen px-4 sm:px-6 lg:px-8 max-w-7xl mx-auto">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="max-w-2xl mx-auto mb-6 space-y-2">
            {% for category, message in messages %}
            <div class="rounded-xl p-4 flex items-center gap-3 shadow-sm border
                        {% if category == 'success' %} bg-green-50 text-green-700 border-green-100
                        {% elif category == 'error' %} bg-red-50 text-red-700 border-red-100
                        {% else %} bg-blue-50 text-blue-700 border-blue-100 {% endif %}">
                {% if category == 'success' %}
                    <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                {% elif category == 'error' %}
                    <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                {% else %}
                    <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                {% endif %}
                <span class="text-sm font-medium">{{ message }}</span>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <!-- Announcement Banner -->
        {% if announcement and announcement.enabled and announcement.title %}
        {% set show_announcement = (request.endpoint == 'main.index' and announcement.show_on_homepage) or
                                   (request.endpoint == 'main.ai_project_view' and announcement.show_on_projects) %}
        {% if show_announcement %}
        <div class="max-w-4xl mx-auto mb-8 animate-fade-in-up">
            <div class="bg-gradient-to-r from-pumpkin-50 to-orange-50 border border-pumpkin-100 rounded-2xl p-5 shadow-sm relative overflow-hidden">
                <div class="absolute top-0 right-0 -mt-2 -mr-2 w-16 h-16 bg-pumpkin-200 rounded-full opacity-20 blur-xl"></div>
                <h3 class="font-bold text-pumpkin-800 text-lg mb-1 flex items-center gap-2">
                    <span class="inline-block w-2 h-2 rounded-full bg-pumpkin-500 animate-pulse"></span>
                    {{ announcement.title }}
                </h3>
                {% if announcement.content %}
                <p class="text-pumpkin-700 text-sm leading-relaxed opacity-90">{{ announcement.content }}</p>
                {% endif %}
            </div>
        </div>
        {% endif %}
        {% endif %}

        {% block content %}{% endblock %}
    </main>

    <!-- Mobile Bottom Navigation (Floating Glass Dock) -->
    <nav class="md:hidden fixed bottom-6 left-4 right-4 z-50 glass-card rounded-2xl p-1.5 shadow-2xl shadow-pumpkin-900/10 animate-fade-in-up delay-300">
        <div class="flex justify-between items-center px-2">

            <a href="{{ url_for('main.index') }}" class="flex flex-col items-center justify-center w-12 h-12 rounded-xl transition-all duration-200 tap-highlight-transparent {{ 'bg-pumpkin-50 text-pumpkin-600' if request.endpoint == 'main.index' else 'text-gray-400 hover:bg-gray-50' }}">
                <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
            </a>

            <a href="{{ url_for('main.article_list') }}" class="flex flex-col items-center justify-center w-12 h-12 rounded-xl transition-all duration-200 tap-highlight-transparent {{ 'bg-pumpkin-50 text-pumpkin-600' if request.endpoint == 'main.article_list' else 'text-gray-400 hover:bg-gray-50' }}">
                <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                </svg>
            </a>

            <!-- Featured 'Drive' Button (Center, slightly larger/raised) -->
            <div class="relative -top-6">
                <a href="{{ url_for('results.modal_drive') }}" class="flex items-center justify-center w-14 h-14 rounded-full bg-gradient-to-br from-pumpkin-500 to-rose-500 text-white shadow-lg shadow-pumpkin-500/30 transform transition-transform active:scale-95 border-4 border-gray-50">
                    <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 15v4c0 1.1.9 2 2 2h14a2 2 0 0 0 2-2v-4M17 9l-5 5-5-5M12 12.8V2.5"/>
                    </svg>
                </a>
            </div>

            {% if settings.get('chat_enabled', True) %}
            <a href="{{ url_for('main.chat') }}" class="relative flex flex-col items-center justify-center w-12 h-12 rounded-xl transition-all duration-200 tap-highlight-transparent {{ 'bg-pumpkin-50 text-pumpkin-600' if request.endpoint == 'main.chat' else 'text-gray-400 hover:bg-gray-50' }}">
                <span class="chat-unread-badge absolute top-2 right-2 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white hidden"></span>
                <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
                </svg>
            </a>
            {% endif %}

            {% if session.get('logged_in') %}
            <a href="{{ url_for('main.cloud_terminal') }}" class="flex flex-col items-center justify-center w-12 h-12 rounded-xl transition-all duration-200 tap-highlight-transparent {{ 'bg-pumpkin-50 text-pumpkin-600' if request.endpoint == 'main.cloud_terminal' else 'text-gray-400 hover:bg-gray-50' }}">
                <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="4 17 10 11 4 5"></polyline>
                    <line x1="12" y1="19" x2="20" y2="19"></line>
                </svg>
            </a>
            {% endif %}

            <a href="{{ url_for('main.profile') }}" class="flex flex-col items-center justify-center w-12 h-12 rounded-xl transition-all duration-200 tap-highlight-transparent {{ 'bg-pumpkin-50 text-pumpkin-600' if request.endpoint == 'main.profile' else 'text-gray-400 hover:bg-gray-50' }}">
                <div class="w-6 h-6 rounded-full overflow-hidden border border-current">
                     <img src="{{ session.user_avatar or url_for('static', filename='avatars/default.svg') }}" class="w-full h-full object-cover">
                </div>
            </a>
        </div>
    </nav>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Unread chat message count
        function fetchUnreadCount() {
            fetch('/api/chat/unread-count')
                .then(response => response.json())
                .then(data => {
                    const badges = document.querySelectorAll('.chat-unread-badge');
                    badges.forEach(badge => {
                        if (data.success && data.unread_count > 0) {
                            badge.textContent = data.unread_count > 99 ? '99+' : data.unread_count;
                            badge.classList.remove('hidden');
                            badge.classList.add('inline-flex', 'items-center', 'justify-center');
                            // For the simple dot in mobile nav
                            if (badge.classList.contains('w-2.5')) {
                                badge.textContent = '';
                            }
                        } else {
                            badge.classList.add('hidden');
                            badge.classList.remove('inline-flex');
                        }
                    });
                })
                .catch(error => console.error('Error fetching unread count:', error));
        }

        fetchUnreadCount();
        setInterval(fetchUnreadCount, 30000);
    });
    </script>
</body>
</html>
