{% extends "layout.html" %}

{% block meta_description %}
<meta name="description" content="åœ¨å—ç“œAIä¸Šè¿è¡Œå’Œæ¢ç´¢ &quot;{{ ai_project.name }}&quot;ã€‚{{ (ai_project.description or 'å¼ºå¤§çš„AIå·¥å…·ï¼Œç­‰å¾…æ‚¨çš„æ¢ç´¢') | truncate(100) }}">
{% endblock %}

{% block hreflang_tags %}
  {% for link in hreflang_links %}
    <link rel="alternate" hreflang="{{ link.lang }}" href="{{ link.url }}">
  {% endfor %}
{% endblock %}

{% block title %}{{ ai_project.name }} - å—ç“œAI{% endblock %}
{% block content %}
<div class="ai-project-page">
    <div class="project-content">
        <div class="main-panel card">
    {% if ai_project.cover %}
    <div class="project-cover" style="margin-bottom: 20px;">
        {% set cover_url = ai_project.cover if ai_project.cover.startswith('http') else to_s3_url(ai_project.cover) %}
        {% if ai_project.cover_type == 'video' %}
            <video src="{{ cover_url }}" autoplay muted loop playsinline style="width: 100%; border-radius: 8px 8px 0 0;"></video>
        {% else %}
            <img src="{{ cover_url }}" alt="{{ ai_project.name }} Cover" style="width: 100%; border-radius: 8px 8px 0 0; object-fit: cover; max-height: 400px;">
        {% endif %}
    </div>
    {% endif %}
            <div class="panel-header">
                <div class="project-details">
                    <h1 class="project-title">{{ ai_project.name }}</h1>
                    <p class="project-description">{{ ai_project.description or 'å¼ºå¤§çš„AIå·¥å…·ï¼Œç­‰å¾…æ‚¨çš„æ¢ç´¢' }}</p>
                </div>
            </div>


            <div id="invitation-nag-message" style="display: none; background-color: #fff3cd; border: 1px solid #ffeeba; color: #856404; padding: 15px; border-radius: 5px; margin: 0 20px 15px;">
                éƒ¨åˆ†é«˜çº§GPUå·²è¢«é”å®šã€‚ <a href="{{ url_for('main.profile') }}" style="font-weight: bold; color: #856404;">ç»‘å®šé‚€è¯·ç </a> æ¥è§£é”æ‰€æœ‰åŠŸèƒ½ã€‚
            </div>
            <div id="error-message" style="display: none; color: red; margin-bottom: 10px; padding: 10px; border: 1px solid red; border-radius: 5px; background-color: #fdd;"></div>
            <form id="inference-form" class="inference-form">
                {% if space_card_type == 'cerebrium' %}
                {% if not session.logged_in %}
                <div class="alert" style="padding: 12px; border-radius: 6px; background: #fff4e5; border: 1px solid #ffe0b2; color: #a65b00; margin-bottom: 20px;">
                    è¯¥å¡ç‰‡éœ€è¦ç™»å½•åæ‰èƒ½ä½¿ç”¨ï¼Œè¯·å…ˆ <a href="{{ url_for('auth.login') }}">ç™»å½•</a> æˆ– <a href="{{ url_for('auth.register') }}">æ³¨å†Œ</a>ã€‚
                </div>
                {% endif %}
                {% if session.logged_in and not custom_gpu_configs %}
                <div class="alert" style="padding: 12px; border-radius: 6px; background: #ffe8e8; border: 1px solid #ffb3b3; color: #c62828; margin-bottom: 20px;">
                    ä½ è¿˜æ²¡æœ‰è¢«åˆ†é…å¯ç”¨çš„ GPUã€‚è¯·è”ç³»ç®¡ç†å‘˜åœ¨ç”¨æˆ·ç®¡ç†ä¸­ä¸ºä½ æ·»åŠ è¯·æ±‚åœ°å€ä¸å¯†é’¥ã€‚
                </div>
                {% endif %}

                <div class="form-group">
                    <label for="custom-gpu-select" class="form-label">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg>
                        è¯·é€‰æ‹©ä¸€ä¸ªGPU
                    </label>
                    <select id="custom-gpu-select" {% if not custom_gpu_configs %}disabled{% endif %}>
                        {% if custom_gpu_configs %}
                        <option value="">-- è¯·é€‰æ‹©ä¸€ä¸ªGPU --</option>
                        {% for config in custom_gpu_configs %}
                        <option value="{{ config.id }}">{{ config.name }}</option>
                        {% endfor %}
                        {% else %}
                        <option value="">æš‚æ— å¯ç”¨GPUï¼Œè¯·è”ç³»ç®¡ç†å‘˜</option>
                        {% endif %}
                    </select>
                    <small style="color: #666; display:block; margin-top:4px;">ç®¡ç†å‘˜å¯ä»¥ä¸ºä½ åˆ†é…å¤šä¸ªè¯·æ±‚åœ°å€ä¸å¯†é’¥ï¼Œæ­¤å¤„ä»¥ GPU åç§°å±•ç¤ºã€‚</small>
                </div>

                <div class="form-group">
                    <label class="form-label">è§†é¢‘è¾“å…¥</label>
                    <div class="mode-selector">
                        <label><input type="radio" name="video-source" value="pan" checked> ä»ç½‘ç›˜é€‰æ‹©</label>
                        <label><input type="radio" name="video-source" value="url"> ä½¿ç”¨å¤–éƒ¨é“¾æ¥</label>
                    </div>
                    <div id="video-pan-section" class="picker-section">
                        <button type="button" id="select-video-btn" class="btn btn-secondary">é€‰æ‹©ä¸€ä¸ªè§†é¢‘æ–‡ä»¶ (.mp4)</button>
                        <div id="video-file-display" class="file-name">æœªé€‰æ‹©æ–‡ä»¶</div>
                    </div>
                    <div id="video-url-section" class="picker-section hidden">
                        <input type="text" id="video-url-input" placeholder="https://example.com/video.mp4">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">éŸ³é¢‘è¾“å…¥</label>
                    <div class="mode-selector">
                        <label><input type="radio" name="audio-source" value="pan" checked> ä»ç½‘ç›˜é€‰æ‹©</label>
                        <label><input type="radio" name="audio-source" value="url"> ä½¿ç”¨å¤–éƒ¨é“¾æ¥</label>
                    </div>
                    <div id="audio-pan-section" class="picker-section">
                        <button type="button" id="select-audio-btn" class="btn btn-secondary">é€‰æ‹©éŸ³é¢‘æ–‡ä»¶ (.wav / .mp3)</button>
                        <div id="audio-file-display" class="file-name">æœªé€‰æ‹©æ–‡ä»¶</div>
                    </div>
                    <div id="audio-url-section" class="picker-section hidden">
                        <input type="text" id="audio-url-input" placeholder="https://example.com/audio.wav">
                    </div>
                </div>

                <input type="hidden" id="video-file-key">
                <input type="hidden" id="audio-file-key">

                <div id="custom-gpu-error" class="warning" style="display: none;"></div>

                <div class="form-actions">
                    <button id="custom-gpu-submit-button" type="button" class="btn btn-primary btn-large">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
                        å¼€å§‹å¤„ç†
                    </button>
                </div>
                {% endif %}
                {% if space_card_type != 'cerebrium' %}
                <div class="form-group" id="prompt-group">
                    <label for="prompt" class="form-label">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                        åˆ›æ„æè¿°
                    </label>
                    <textarea id="prompt" name="prompt"
                              placeholder="æè¿°æ‚¨æƒ³è¦åˆ›å»ºçš„å†…å®¹..."
                              rows="4"
                              required></textarea>
                </div>

                <div class="form-group">
                    <label for="template-select" class="form-label">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg>
                        è¯·é€‰æ‹©ä¸€ä¸ªGPU
                    </label>
                    <select id="template-select" name="template_id" class="form-control" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>

                <div id="parameters-container" class="parameters-section" style="display: none;">
                    <h3 class="section-title">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                        å‚æ•°è®¾ç½®
                    </h3>
                    <div id="parameters-grid" class="parameters-grid">
                        <!-- Parameters for the selected template will be rendered here -->
                    </div>
                </div>

                <div id="file-upload-container" class="form-group" style="display: none;">
                    <label for="input_file" class="form-label">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                        <span id="file-upload-label">ä¸Šä¼ æ–‡ä»¶</span>
                    </label>
                    <div class="file-upload-area">
                        <button type="button" id="select-file-btn" class="btn btn-secondary">ä»æ–‡ä»¶åº“é€‰æ‹©</button>
                        <div id="selected-file-display" style="margin-top: 10px; font-weight: bold;"></div>
                    </div>
                    <input type="hidden" name="s3_object_keys" id="s3_object_keys">
                </div>

                <div class="form-actions">
                    <button id="submit-button" type="submit" class="btn btn-primary btn-large" {% if is_waiting_for_file %}disabled{% endif %}>
                        {% if is_waiting_for_file %}
                        <span class="loading"></span>
                        å¤„ç†ä¸­...
                        {% else %}
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
                        å¼€å§‹ç”Ÿæˆ
                        {% endif %}
                    </button>
                    <span id="timeout-message" class="timeout-message"></span>
                </div>
                {% endif %}

                {% if space_card_type == 'websocket' %}
                <div id="websocket-form-container">
                    {% set inputs = ai_project.allowed_input_types or ['text'] %}
                    {% if 'text' in inputs %}
                    <div class="form-group">
                        <label for="ws-prompt" class="form-label">æç¤ºè¯</label>
                        <textarea id="ws-prompt" name="prompt" rows="3" class="form-control" placeholder="è¯·è¾“å…¥æ‚¨çš„æç¤º..."></textarea>
                    </div>
                    {% endif %}
                    {% if 'audio' in inputs or 'image' in inputs %}
                    <div class="form-group">
                        <label for="ws-file" class="form-label">ä¸Šä¼ æ–‡ä»¶</label>
                        <input type="file" id="ws-file" name="file" class="form-control">
                    </div>
                    {% endif %}
                    <div class="form-actions">
                        <button id="ws-submit-button" type="button" class="btn btn-primary btn-large">æäº¤ä»»åŠ¡</button>
                    </div>
                </div>
                {% endif %}
            </form>

            <!-- API Examples Section -->
            {% if api_examples and space_card_type != 'cerebrium' %}
            <div class="api-examples-section">
                <h3 class="section-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-code"><polyline points="16 18 22 12 16 6"></polyline><polyline points="8 6 2 12 8 18"></polyline></svg>
                    API ä½¿ç”¨ç¤ºä¾‹
                </h3>
                {% for example in api_examples %}
                <div class="api-example" id="api-example-{{ example.id }}">
                    <h4>{{ example.name }}</h4>
                    <div class="api-tabs">
                        <button class="api-tab-button" data-tab-target="#curl-{{ example.id }}">cURL</button>
                        <button class="api-tab-button" data-tab-target="#python-async-{{ example.id }}">Python (Async)</button>
                        <button class="api-tab-button" data-tab-target="#python-stream-{{ example.id }}">Python (Stream)</button>
                    </div>

                    <div id="curl-{{ example.id }}" class="api-tab-content">
                        <div class="code-block-container">
                            <pre><code id="code-curl-{{ example.id }}">{{ example.curl }}</code></pre>
                            <button class="copy-button" data-clipboard-target="#code-curl-{{ example.id }}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                                å¤åˆ¶
                            </button>
                        </div>
                    </div>
                    <div id="python-async-{{ example.id }}" class="api-tab-content">
                        <div class="code-block-container">
                            <pre><code id="code-python-async-{{ example.id }}">{{ example.python_async }}</code></pre>
                            <button class="copy-button" data-clipboard-target="#code-python-async-{{ example.id }}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                                å¤åˆ¶
                            </button>
                        </div>
                    </div>
                    <div id="python-stream-{{ example.id }}" class="api-tab-content">
                        <div class="code-block-container">
                            <pre><code id="code-python-stream-{{ example.id }}">{{ example.python_stream }}</code></pre>
                            <button class="copy-button" data-clipboard-target="#code-python-stream-{{ example.id }}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                                å¤åˆ¶
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

        </div>

        <div class="side-panel">
            <div class="card mb-3">
                <a href="{{ url_for('main.chat') }}" class="btn btn-secondary btn-block">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                    è¿›å…¥èŠå¤©å®¤
                </a>
            </div>
            <div class="result-card card">
                <h3 class="card-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>
                    ç”Ÿæˆç»“æœ
                </h3>
                <div id="status" class="result-status">
                    <div id="result-content" class="result-content">
                        {% if space_card_type == 'cerebrium' and last_custom_gpu_result %}
                        {% set result_status = last_custom_gpu_result.status or 'completed' %}
                        {% set recent_name = last_custom_gpu_result.filename or (last_custom_gpu_result.output_key and last_custom_gpu_result.output_key.split('/')[-1]) or 'è¾“å‡ºè§†é¢‘.mp4' %}
                        <div class="result-preview {% if result_status != 'completed' %}result-preview--pending{% endif %}">
                            <div class="result-meta"><strong>è¾“å‡ºæ–‡ä»¶ï¼š</strong>{{ recent_name }}</div>
                            {% if result_status == 'completed' and last_custom_gpu_result.public_url %}
                            <video src="{{ last_custom_gpu_result.public_url }}" controls playsinline style="width:100%; border-radius:8px; background:#000"></video>
                            <p class="result-hint">è‹¥è§†é¢‘æ²¡æœ‰ç«‹å³æ’­æ”¾ï¼Œå¯ç¨ååœ¨ <a href="{{ url_for('results.my_results') }}">æˆ‘çš„ä½œå“</a> ä¸­æŸ¥çœ‹ã€‚</p>
                            {% elif result_status == 'pending' %}
                            <p class="result-hint processing">ä»»åŠ¡æ‰§è¡Œä¸­ï¼Œå®Œæˆåæœ€æ–°ç»“æœä¼šè‡ªåŠ¨å‡ºç°åœ¨æ­¤å¤„ï¼Œæˆ–å‰å¾€ <a href="{{ url_for('results.my_results') }}">æˆ‘çš„ä½œå“</a> æŸ¥çœ‹ ({{ recent_name }})ã€‚</p>
                            {% elif result_status == 'timeout' %}
                            <p class="result-hint timeout">ä¸Šä¸€æ¬¡ä»»åŠ¡å·²è¶…æ—¶ ({{ recent_name }})ï¼Œè¯·æ£€æŸ¥ GPU æœåŠ¡åé‡æ–°å¼€å§‹ã€‚</p>
                            {% else %}
                            <p class="result-hint">ç­‰å¾…ä»»åŠ¡å¼€å§‹...</p>
                            {% endif %}
                        </div>
                        {% else %}
                        ç­‰å¾…ä»»åŠ¡å¼€å§‹...
                        {% endif %}
                    </div>
                </div>
            </div>

            {% if session.logged_in %}
            <div class="logs-card card">
                <h3 class="card-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="8" y1="12" x2="16" y2="12"></line><line x1="12" y1="8" x2="12" y2="16"></line></svg>
                    æ‰§è¡Œæ—¥å¿—
                </h3>
                {% if space_card_type == 'cerebrium' %}
                <div class="logs-content">è¯¥å¡ç‰‡é€šè¿‡æµè§ˆå™¨ç›´æ¥è°ƒç”¨å¤–éƒ¨ GPU æœåŠ¡ï¼Œæš‚ä¸æä¾›è¿œç¨‹æ—¥å¿—ã€‚è¿è¡ŒçŠ¶æ€ä¼šåœ¨å³ä¾§å®æ—¶æ›´æ–°ã€‚</div>
                {% else %}
                <div id="logs" class="logs-content">ç­‰å¾…æ—¥å¿—...</div>
                {% endif %}
            </div>
            {% endif %}

            <div class="status-card card">
                <h3 class="card-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"></path></svg>
                    çŠ¶æ€ä¿¡æ¯
                </h3>
                <div class="status-item">
                    <span class="status-label">å½“å‰çŠ¶æ€:</span>
                    <span class="status-value {% if is_waiting_for_file %}processing{% else %}ready{% endif %}">
                        {% if is_waiting_for_file %}å¤„ç†ä¸­{% else %}å°±ç»ª{% endif %}
                    </span>
                </div>
                {% if session.is_admin %}
                <div class="status-item">
                    <span class="status-label">APIå¯†é’¥:</span>
                    <span class="status-value">{{ api_key[:8] }}...</span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- File Browser Modal -->
<div id="file-browser-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>æ–‡ä»¶åº“</h2>
            <span class="close-button">&times;</span>
        </div>
        <div class="modal-body">
            <div id="file-browser-list" class="file-list-container">
                <!-- File list will be loaded here -->
                <p>æ­£åœ¨åŠ è½½æ–‡ä»¶...</p>
            </div>
        </div>
    </div>
</div>


<style>
/* Modal Styles */
.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background-color: #fefefe;
    margin: auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
    max-width: 900px;
    border-radius: 8px;
    box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2);
    display: flex;
    flex-direction: column;
    max-height: 90vh;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #ddd;
    padding-bottom: 10px;
    margin-bottom: 20px;
}

.modal-header h2 {
    margin: 0;
    font-size: 24px;
}

.close-button {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close-button:hover,
.close-button:focus {
    color: black;
    text-decoration: none;
}

.modal-body {
    overflow-y: auto;
}

.file-list-container {
    /* Styles for the file list, borrowing from my_results.html */
}

.ai-project-page { max-width: 1200px; margin: 0 auto; padding: 20px; }
.project-content { display: grid; grid-template-columns: 1fr 400px; gap: 30px; }
.main-panel { background: var(--system-background); border: 1px solid var(--separator-color); border-radius: 8px; }
.panel-header { padding: 20px; border-bottom: 1px solid var(--separator-color); }
.panel-header h2 { font-size: 20px; font-weight: 600; color: var(--primary-text); margin: 0; }
.panel-header p { color: var(--secondary-text); margin: 4px 0 0 0; }
.inference-form { padding: 20px; }
.form-group { margin-bottom: 20px; }
.form-label { font-weight: 600; color: var(--primary-text); margin-bottom: 8px; font-size: 14px; display: flex; align-items: center; gap: 8px; }
.form-group textarea, .form-group input[type="text"] {
    width: 100%; padding: 10px; border: 1px solid var(--separator-color); border-radius: 6px;
    background: var(--system-background-secondary); font-size: 14px; box-sizing: border-box;
}
.form-group textarea:focus, .form-group input[type="text"]:focus { outline: none; border-color: var(--secondary-text); }
.parameters-section { margin: 20px 0; padding: 20px; background: var(--system-background-secondary); border-radius: 8px; }
.section-title { font-size: 16px; font-weight: 600; margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;}
.file-upload-area { border: 2px dashed var(--separator-color); border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; }
.file-upload-area:hover { border-color: var(--secondary-text); }
.form-actions { text-align: center; margin-top: 20px; }
.side-panel { display: flex; flex-direction: column; gap: 20px; }
.result-card, .logs-card, .status-card { background: var(--system-background); border: 1px solid var(--separator-color); border-radius: 8px; padding: 20px; }
.card-title { font-size: 16px; font-weight: 600; margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;}
.result-status, .logs-content { background: var(--system-background-secondary); border-radius: 6px; padding: 16px; min-height: 100px; }
.logs-content { font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; }
.status-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--separator-color); font-size: 14px; }
.status-item:last-child { border-bottom: none; }
.status-label { color: var(--secondary-text); }
.status-value.ready { color: #28a745; }
.status-value.processing { color: #fd7e14; }
.result-preview video { width: 100%; border-radius: 8px; background: #000; margin-top: 8px; }
.result-meta { font-size: 14px; color: var(--primary-text); }
.result-hint { font-size: 12px; color: #666; margin-top: 8px; }
.result-hint.processing { color: #3c78ff; }
.result-hint.timeout { color: #c62828; }
.result-preview--pending {
    border: 1px dashed var(--separator-color);
    border-radius: 8px;
    padding: 12px;
    background: rgba(60, 120, 255, 0.05);
}

@media (max-width: 1024px) {
    .project-content { grid-template-columns: 1fr; gap: 20px; }
    .side-panel { order: -1; }
}

/* API Examples Styles */
.api-examples-section {
    padding: 20px;
    margin-top: 20px;
    background: var(--system-background-secondary);
    border-radius: 8px;
}
.api-example {
    margin-bottom: 20px;
}
.api-example:last-child {
    margin-bottom: 0;
}
.api-example h4 {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 10px;
}
.code-block-container {
    position: relative;
}
.code-block-container pre {
    background-color: #0d1117; /* Dark background for code */
    color: #c9d1d9; /* Light text for contrast */
    padding: 16px;
    border-radius: 6px;
    overflow-x: auto;
    font-family: 'SF Mono', 'Consolas', 'Menlo', monospace;
    font-size: 14px;
}
.copy-button {
    position: absolute;
    top: 10px;
    right: 10px;
    background-color: #21262d;
    color: #c9d1d9;
    border: 1px solid #30363d;
    border-radius: 6px;
    padding: 5px 10px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 12px;
    opacity: 0.8;
    transition: opacity 0.2s ease-in-out;
}
.copy-button:hover {
    background-color: #30363d;
    opacity: 1;
}

/* API Tabs Styles */
.api-tabs {
    display: flex;
    border-bottom: 1px solid var(--separator-color);
    margin-bottom: 15px;
}
.api-tab-button {
    padding: 10px 15px;
    cursor: pointer;
    border: none;
    background-color: transparent;
    font-size: 14px;
    font-weight: 500;
    color: var(--secondary-text);
    position: relative;
    border-bottom: 2px solid transparent;
    transition: all 0.3s ease;
}
.api-tab-button.active {
    color: var(--primary-text);
    border-bottom-color: var(--primary-text);
}
.api-tab-content {
    display: none;
}
.api-tab-content.active {
    display: block;
}
.mode-selector {
    display: flex;
    gap: 16px;
    margin-bottom: 8px;
    flex-wrap: wrap;
}
.mode-selector label {
    font-weight: 500;
    color: var(--secondary-text);
}
.picker-section {
    border: 1px dashed var(--separator-color);
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 10px;
}
.file-name {
    margin-top: 8px;
    font-style: italic;
    color: #555;
    word-break: break-all;
}
.hidden { display: none; }
.warning {
    color: #c62828;
    background: #ffeaea;
    border: 1px solid #ffbdbd;
    border-radius: 6px;
    padding: 10px;
    margin-top: 10px;
}

.field-error {
    border-color: #ff6b6b !important;
    box-shadow: 0 0 0 2px rgba(255, 107, 107, 0.15);
}

.btn[disabled], .btn.disabled {
    opacity: 0.6;
    cursor: not-allowed;
    pointer-events: none;
}
</style>

{% if space_card_type == 'cerebrium' %}
<script src="https://sdk.amazonaws.com/js/aws-sdk-2.1093.0.min.js"></script>
{% endif %}
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

<script>
function initWebSocketFlow() {
    const aiProjectId = '{{ ai_project.id }}';
    const submitBtn = document.getElementById('ws-submit-button');
    const statusDiv = document.getElementById('status');
    const resultContent = document.getElementById('result-content');
    const promptInput = document.getElementById('ws-prompt');
    const fileInput = document.getElementById('ws-file');

    if (!submitBtn) return;

    const socket = io({ autoConnect: false });

    socket.on('connect', () => {
        console.log('WebSocket connected.');
    });

    socket.on('task_update', (data) => {
        console.log('Task update received:', data);
        let statusHtml = `<h4>ä»»åŠ¡çŠ¶æ€: ${data.status}</h4>`;

        if (data.position) {
            statusHtml += `<p>é˜Ÿåˆ—ä½ç½®: ${data.position}</p>`;
        }

        if (data.status === 'completed') {
            let resultHtml = '<h3>ç»“æœ:</h3>';
            if (data.result && typeof data.result.output === 'string') {
                resultHtml += `<p>${data.result.output}</p>`;
            } else {
                resultHtml += `<pre>${JSON.stringify(data.result, null, 2)}</pre>`;
            }
            resultContent.innerHTML = resultHtml;
            submitBtn.disabled = false;
            socket.disconnect();
        } else if (data.status === 'failed') {
            statusHtml += `<p class="error">é”™è¯¯: ${data.error || 'ä»»åŠ¡å¤±è´¥'}</p>`;
            resultContent.innerHTML = statusHtml;
            submitBtn.disabled = false;
            socket.disconnect();
        } else {
            resultContent.innerHTML = statusHtml;
        }
    });

    socket.on('disconnect', () => {
        console.log('WebSocket disconnected.');
    });

    submitBtn.addEventListener('click', async () => {
        const textInput = promptInput ? promptInput.value.trim() : null;

        if (!textInput) {
            alert('è¯·è¾“å…¥æç¤º');
            return;
        }

        submitBtn.disabled = true;
        resultContent.innerHTML = '<h4>ğŸš€ æäº¤ä¸­...</h4>';

        const payload = {
            inputs: {
                text: textInput,
            }
        };

        if (fileInput && fileInput.files[0]) {
            const file = fileInput.files[0];
            const presigned_url_response = await fetch(`{{ url_for('api.generate_upload_url') }}?fileName=${file.name}&contentType=${file.type}`);
            const presigned_data = await presigned_url_response.json();

            if (!presigned_data.success) {
                throw new Error(presigned_data.error || 'æ— æ³•è·å–ä¸Šä¼ URL');
            }

            await fetch(presigned_data.presigned_url, {
                method: 'PUT',
                body: file,
                headers: {
                    'Content-Type': file.type,
                }
            });

            payload.inputs.image = presigned_data.final_url;
        }


        try {
            const response = await fetch(`/api/space/${aiProjectId}/submit_task`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                 const errorData = await response.json();
                throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            const taskId = data.task_id;

            resultContent.innerHTML = `<h4>ä»»åŠ¡å·²æäº¤ (ID: ${taskId})</h4><p>å½“å‰çŠ¶æ€: ${data.status}, é˜Ÿåˆ—ä½ç½®: ${data.position}</p>`;

            // Connect and join room for this task
            socket.connect();
            socket.on('connect', () => {
                socket.emit('join_task_room', { task_id: taskId });
            });


        } catch (error) {
            console.error('Error submitting task:', error);
            resultContent.innerHTML = `<h4>âŒ æäº¤å¤±è´¥</h4><p>${error.message}</p>`;
            submitBtn.disabled = false;
        }
    });
}

function initCustomGpuFlow() {
    const isLoggedIn = {{ session.get('logged_in')|tojson }};
    const customGpuConfigs = {{ custom_gpu_configs | tojson | safe }} || [];
    const lastResult = {{ last_custom_gpu_result | tojson | safe }};
    const aiProjectId = '{{ ai_project.id }}';
    const timeoutConfig = {{ custom_gpu_timeout_seconds | default(300) | tojson }};
    const parsedTimeout = Number(timeoutConfig);
    const customGpuTimeoutSeconds = parsedTimeout > 0 ? parsedTimeout : 300;
    const customGpuTimeoutMs = customGpuTimeoutSeconds * 1000;
    const configsById = {};
    customGpuConfigs.forEach(cfg => {
        configsById[cfg.id] = cfg;
    });

    const gpuSelect = document.getElementById('custom-gpu-select');
    const submitButton = document.getElementById('custom-gpu-submit-button');
    const errorBox = document.getElementById('custom-gpu-error');
    const statusBox = document.getElementById('status');
    const resultContent = document.getElementById('result-content');
    const selectVideoBtn = document.getElementById('select-video-btn');
    const selectAudioBtn = document.getElementById('select-audio-btn');
    const videoKeyInput = document.getElementById('video-file-key');
    const audioKeyInput = document.getElementById('audio-file-key');
    const videoDisplay = document.getElementById('video-file-display');
    const audioDisplay = document.getElementById('audio-file-display');
    const videoUrlInput = document.getElementById('video-url-input');
    const audioUrlInput = document.getElementById('audio-url-input');
    const videoSourceRadios = document.querySelectorAll('input[name="video-source"]');
    const audioSourceRadios = document.querySelectorAll('input[name="audio-source"]');
    const videoPanSection = document.getElementById('video-pan-section');
    const videoUrlSection = document.getElementById('video-url-section');
    const audioPanSection = document.getElementById('audio-pan-section');
    const audioUrlSection = document.getElementById('audio-url-section');
    const modal = document.getElementById('file-browser-modal');
    const fileListContainer = document.getElementById('file-browser-list');
    const closeBtn = document.querySelector('.close-button');
    const filesApiUrl = '{{ url_for("api.list_my_s3_files") }}';
    const s3ContextUrl = '{{ url_for("api.get_custom_gpu_s3_context") }}';
    const resultsUrl = '{{ url_for("results.my_results") }}';
    const saveResultUrl = '{{ url_for("api.save_custom_gpu_result") }}';

    if (!submitButton) {
        return;
    }

    let isSubmitting = false;
    let activeFileSelection = null;
    let cachedS3Context = null;
    let s3Client = null;
    let publicBaseUrl = {{ s3_public_base_url|tojson }};
    let pendingTimeoutTimer = null;
    let pendingJobKey = null;
    let pendingJobName = null;
    let isPendingLocked = false;

    function setStatus(message) {
        if (statusBox) {
            statusBox.textContent = message;
        }
    }

    function showError(message) {
        if (!errorBox) return;
        errorBox.textContent = message;
        errorBox.style.display = 'block';
    }

    function clearError() {
        if (!errorBox) return;
        errorBox.style.display = 'none';
        errorBox.textContent = '';
    }

    function isSourceReady(kind) {
        const mode = document.querySelector(`input[name="${kind}-source"]:checked`);
        if (!mode) return false;
        if (mode.value === 'pan') {
            return (kind === 'video' ? videoKeyInput.value : audioKeyInput.value).length > 0;
        }
        return (kind === 'video' ? videoUrlInput.value.trim() : audioUrlInput.value.trim()).length > 0;
    }

    function updateButtonState() {
        if (!submitButton) return;
        if (!isLoggedIn || customGpuConfigs.length === 0) {
            submitButton.disabled = true;
            return;
        }
        const videoReady = isSourceReady('video');
        const audioReady = isSourceReady('audio');
        submitButton.disabled = !(videoReady && audioReady) || isSubmitting || isPendingLocked;
    }

    function bindSourceToggle(radios, panSection, urlSection) {
        radios.forEach(radio => {
            radio.addEventListener('change', () => {
                const usePan = document.querySelector(`input[name="${radio.name}"]:checked`).value === 'pan';
                panSection.classList.toggle('hidden', !usePan);
                urlSection.classList.toggle('hidden', usePan);
                updateButtonState();
            });
        });
    }

    function formatFilename(key) {
        if (!key) return 'æœªé€‰æ‹©æ–‡ä»¶';
        const parts = key.split('/');
        return parts[parts.length - 1];
    }

    function renderResultPreview(result) {
        if (!resultContent) return;
        if (!result) {
            resultContent.textContent = 'ç­‰å¾…ä»»åŠ¡å¼€å§‹...';
            return;
        }
        const status = result.status || 'completed';
        const displayName = result.filename || (result.output_key ? formatFilename(result.output_key) : 'è¾“å‡ºè§†é¢‘.mp4');
        const isCompleted = status === 'completed';
        let innerHtml = `
            <div class="result-preview ${!isCompleted ? 'result-preview--pending' : ''}">
                <div class="result-meta"><strong>è¾“å‡ºæ–‡ä»¶ï¼š</strong>${displayName}</div>
        `;
        if (isCompleted && result.public_url) {
            innerHtml += `
                <video src="${result.public_url}" controls playsinline style="width:100%; border-radius:8px; background:#000"></video>
                <p class="result-hint">è‹¥è§†é¢‘æ²¡æœ‰ç«‹å³æ’­æ”¾ï¼Œå¯ç¨ååœ¨ <a href="${resultsUrl}">æˆ‘çš„ä½œå“</a> ä¸­æŸ¥çœ‹ã€‚</p>
            `;
        } else if (status === 'timeout') {
            innerHtml += `
                <p class="result-hint timeout">ä¸Šä¸€æ¬¡ä»»åŠ¡å·²è¶…æ—¶ (${displayName})ï¼Œè¯·æ£€æŸ¥ GPU æœåŠ¡åé‡æ–°å¼€å§‹ã€‚</p>
            `;
        } else {
            innerHtml += `
                <p class="result-hint processing">ä»»åŠ¡æ‰§è¡Œä¸­ï¼Œå®Œæˆåæœ€æ–°ç»“æœä¼šè‡ªåŠ¨å‡ºç°åœ¨æ­¤å¤„ï¼Œæˆ–å‰å¾€ <a href="${resultsUrl}">æˆ‘çš„ä½œå“</a> æŸ¥çœ‹ (${displayName})ã€‚</p>
            `;
        }
        innerHtml += '</div>';
        resultContent.innerHTML = innerHtml;
    }

    function bindFilePicker(button, keyInput, displayEl) {
        if (!button) return;
        button.addEventListener('click', () => {
            if (!isLoggedIn) {
                alert('è¯·å…ˆç™»å½•åå†é€‰æ‹©æ–‡ä»¶ã€‚');
                return;
            }
            activeFileSelection = { keyInput, displayEl };
            openFileModal(keyInput.value);
        });
    }

    function beginPendingLock(durationMs, jobInfo) {
        if (!submitButton || !jobInfo || !jobInfo.outputKey || durationMs <= 0) {
            return;
        }
        if (pendingTimeoutTimer) {
            clearTimeout(pendingTimeoutTimer);
        }
        pendingJobKey = jobInfo.outputKey;
        pendingJobName = jobInfo.filename || formatFilename(jobInfo.outputKey);
        isPendingLocked = true;
        pendingTimeoutTimer = setTimeout(handlePendingTimeout, durationMs);
        submitButton.disabled = true;
        submitButton.classList.add('disabled');
        updateButtonState();
    }

    function clearPendingLock() {
        if (pendingTimeoutTimer) {
            clearTimeout(pendingTimeoutTimer);
            pendingTimeoutTimer = null;
        }
        pendingJobKey = null;
        pendingJobName = null;
        isPendingLocked = false;
        if (submitButton) {
            submitButton.classList.remove('disabled');
        }
        updateButtonState();
    }

    function handlePendingTimeout() {
        pendingTimeoutTimer = null;
        const jobKey = pendingJobKey;
        const jobName = pendingJobName || (jobKey ? formatFilename(jobKey) : 'è¾“å‡ºè§†é¢‘.mp4');
        pendingJobKey = null;
        pendingJobName = null;
        isPendingLocked = false;
        isSubmitting = false;
        if (submitButton) {
            submitButton.classList.remove('disabled');
        }
        updateButtonState();
        renderResultPreview({ status: 'timeout', filename: jobName, output_key: jobKey });
        showError('è¯·æ±‚å·²è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•ã€‚');
        setStatus('è¶…æ—¶ï¼šæœªåœ¨è®¾å®šæ—¶é—´å†…æ”¶åˆ°æ¨ç†ç»“æœã€‚');
        if (jobKey) {
            persistResult(jobKey, jobName, 'timeout');
        }
    }

    function resumePendingLockFromServer(result) {
        if (!result || result.status !== 'pending' || !result.output_key || customGpuTimeoutMs <= 0) {
            return;
        }
        const filename = result.filename || formatFilename(result.output_key);
        const savedAtMsCandidate = Number(result.saved_at_ms);
        let savedAtMs = Number.isFinite(savedAtMsCandidate) ? savedAtMsCandidate : NaN;
        if (Number.isNaN(savedAtMs) && result.saved_at) {
            savedAtMs = Date.parse(result.saved_at);
        }
        if (!Number.isNaN(savedAtMs)) {
            const elapsed = Date.now() - savedAtMs;
            if (elapsed >= customGpuTimeoutMs) {
                renderResultPreview({ ...result, status: 'timeout' });
                setStatus('è¶…æ—¶ï¼šæœªåœ¨è®¾å®šæ—¶é—´å†…æ”¶åˆ°æ¨ç†ç»“æœã€‚');
                persistResult(result.output_key, filename, 'timeout');
                return;
            }
            const timeLeft = Math.max(0, customGpuTimeoutMs - elapsed);
            beginPendingLock(timeLeft, { outputKey: result.output_key, filename });
            setStatus('ä»»åŠ¡æ‰§è¡Œä¸­ï¼Œè¯·ç¨å€™...');
            return;
        }
        beginPendingLock(customGpuTimeoutMs, { outputKey: result.output_key, filename });
        setStatus('ä»»åŠ¡æ‰§è¡Œä¸­ï¼Œè¯·ç¨å€™...');
    }

    function promptGpuSelection() {
        if (!gpuSelect) return;
        gpuSelect.classList.add('field-error');
        gpuSelect.focus();
        gpuSelect.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function renderFileList(files, selectedKey) {
        if (!files || files.length === 0) {
            fileListContainer.innerHTML = '<p>æ–‡ä»¶åº“ä¸­æ²¡æœ‰æ–‡ä»¶ã€‚</p>';
            return;
        }

        const table = document.createElement('table');
        table.className = 'responsive-table';
        table.style = 'width: 100%; border-collapse: collapse;';
        table.innerHTML = `
            <thead>
                <tr>
                    <th style="padding: 12px; text-align: left; width: 80px;">é¢„è§ˆ</th>
                    <th style="padding: 12px; text-align: left;">æ–‡ä»¶å</th>
                    <th style="padding: 12px; text-align: left;">å¤§å°</th>
                    <th style="padding: 12px; text-align: left;">ä¿®æ”¹æ—¥æœŸ</th>
                    <th style="padding: 12px; text-align: center;">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody></tbody>
        `;

        const tbody = table.querySelector('tbody');
        files.forEach(file => {
            const row = tbody.insertRow();
            if (file.key === selectedKey) {
                row.style.backgroundColor = '#e7f3ff';
            }
            const sizeInMB = file.size / (1024 * 1024);
            const sizeDisplay = isNaN(sizeInMB) ? '-' : (sizeInMB >= 1 ? `${sizeInMB.toFixed(2)} MB` : `${(file.size / 1024).toFixed(2)} KB`);
            const modified = file.last_modified ? new Date(file.last_modified).toLocaleString() : '-';

            let previewHtml = `
                <div style="width: 50px; height: 50px; background-color: #f0f0f0; border-radius: 4px; display: flex; align-items: center; justify-content: center; border: 1px solid #ddd;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>
                </div>
            `;
            if (file.preview_url && (file.is_image || file.is_video)) {
                if (file.is_image) {
                    previewHtml = `<img src="${file.preview_url}" alt="é¢„è§ˆ" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd;">`;
                } else {
                    previewHtml = `<video src="${file.preview_url}#t=0.1" muted loop playsinline style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; background-color:#000;"></video>`;
                }
            }

            row.innerHTML = `
                <td style="padding: 10px; text-align:center;">${previewHtml}</td>
                <td style="padding: 10px;">${file.filename}</td>
                <td style="padding: 10px;">${sizeDisplay}</td>
                <td style="padding: 10px;">${modified}</td>
                <td style="padding: 10px; text-align: center;"></td>
            `;

            const actionCell = row.cells[4];
            const useBtn = document.createElement('button');
            useBtn.type = 'button';
            useBtn.className = 'btn btn-primary btn-sm';
            useBtn.textContent = 'é€‰æ‹©';
            useBtn.addEventListener('click', () => {
                if (activeFileSelection) {
                    activeFileSelection.keyInput.value = file.key;
                    activeFileSelection.displayEl.textContent = formatFilename(file.key);
                }
                modal.style.display = 'none';
                updateButtonState();
            });
            actionCell.appendChild(useBtn);
        });

        fileListContainer.innerHTML = '';
        fileListContainer.appendChild(table);
    }

    async function persistResult(outputKey, fileName, status = 'completed', publicUrl = null) {
        if (!saveResultUrl) return;
        try {
            const payload = {
                ai_project_id: aiProjectId,
                output_key: outputKey,
                filename: fileName,
                status
            };
            if (publicUrl) {
                payload.public_url = publicUrl;
            }
            await fetch(saveResultUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });
        } catch (err) {
            console.warn('Failed to persist GPU result:', err);
        }
    }

    function openFileModal(selectedKey) {
        if (!modal || !fileListContainer) return;
        modal.style.display = 'flex';
        fileListContainer.innerHTML = '<p>æ­£åœ¨åŠ è½½æ–‡ä»¶...</p>';
        fetch(filesApiUrl)
            .then(resp => resp.json())
            .then(data => {
                if (data.success) {
                    renderFileList(data.files, selectedKey);
                } else {
                    fileListContainer.innerHTML = `<p style="color:red;">${data.error || 'æ— æ³•åŠ è½½æ–‡ä»¶'}</p>`;
                }
            })
            .catch(err => {
                fileListContainer.innerHTML = `<p style="color:red;">åŠ è½½æ–‡ä»¶å¤±è´¥: ${err.message}</p>`;
            });
    }

    if (closeBtn && modal) {
        closeBtn.addEventListener('click', () => {
            modal.style.display = 'none';
        });
    }
    window.addEventListener('click', (event) => {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    });

    bindSourceToggle(videoSourceRadios, videoPanSection, videoUrlSection);
    bindSourceToggle(audioSourceRadios, audioPanSection, audioUrlSection);
    bindFilePicker(selectVideoBtn, videoKeyInput, videoDisplay);
    bindFilePicker(selectAudioBtn, audioKeyInput, audioDisplay);

    function resolveMediaUrl(kind) {
        const mode = document.querySelector(`input[name="${kind}-source"]:checked`);
        if (!mode) {
            throw new Error('è¯·é€‰æ‹©æ–‡ä»¶æ¥æº');
        }
        if (mode.value === 'pan') {
            const key = kind === 'video' ? videoKeyInput.value : audioKeyInput.value;
            if (!key) {
                throw new Error(kind === 'video' ? 'è¯·é€‰æ‹©ä¸€ä¸ªè§†é¢‘æ–‡ä»¶' : 'è¯·é€‰æ‹©ä¸€ä¸ªéŸ³é¢‘æ–‡ä»¶');
            }
            if (!publicBaseUrl) {
                throw new Error('S3 é…ç½®ç¼ºå¤±ï¼Œæ— æ³•ç”Ÿæˆæ–‡ä»¶é“¾æ¥');
            }
            return `${publicBaseUrl}/${key}`;
        }
        const input = kind === 'video' ? videoUrlInput : audioUrlInput;
        const value = input.value.trim();
        if (!value) {
            throw new Error(kind === 'video' ? 'è¯·è¾“å…¥è§†é¢‘é“¾æ¥' : 'è¯·è¾“å…¥éŸ³é¢‘é“¾æ¥');
        }
        return value;
    }

    function generateOutputKey(prefix) {
        const rand = Math.random().toString(36).substring(2, 10);
        return `${prefix}/custom-gpu/${Date.now()}_${rand}.mp4`;
    }

    async function ensureS3Context() {
        if (cachedS3Context && s3Client) {
            return cachedS3Context;
        }
        const resp = await fetch(s3ContextUrl);
        const data = await resp.json();
        if (!data.success) {
            throw new Error(data.error || 'æ— æ³•è·å– S3 é…ç½®');
        }
        cachedS3Context = data.context;
        publicBaseUrl = cachedS3Context.public_base_url;
        if (typeof AWS === 'undefined') {
            throw new Error('AWS SDK æœªåŠ è½½ï¼Œæ— æ³•ç”Ÿæˆä¸Šä¼ é“¾æ¥');
        }
        s3Client = new AWS.S3({
            accessKeyId: cachedS3Context.access_key_id,
            secretAccessKey: cachedS3Context.secret_access_key,
            region: cachedS3Context.region,
            endpoint: new AWS.Endpoint(cachedS3Context.endpoint_url),
            s3ForcePathStyle: true,
            signatureVersion: 'v4'
        });
        return cachedS3Context;
    }

    function attachInputListener(el) {
        if (!el) return;
        ['input', 'change'].forEach(evt => {
            el.addEventListener(evt, updateButtonState);
        });
    }

    attachInputListener(gpuSelect);
    attachInputListener(videoUrlInput);
    attachInputListener(audioUrlInput);

    if (gpuSelect) {
        gpuSelect.addEventListener('change', () => {
            gpuSelect.classList.remove('field-error');
            clearError();
        });
    }

    const handleSubmit = async () => {
        if (submitButton.disabled) return;
        clearError();
        if (!isLoggedIn) {
            showError('è¯·ç™»å½•åå†ä½¿ç”¨è¯¥åŠŸèƒ½');
            return;
        }
        if (!customGpuConfigs.length) {
            showError('è¯·è”ç³»ç®¡ç†å‘˜åˆ†é… GPU åå†å°è¯•');
            return;
        }
        const selectedConfig = gpuSelect ? configsById[gpuSelect.value] : null;
        if (!selectedConfig) {
            showError('è¯·é€‰æ‹©ä¸€ä¸ª GPU');
            promptGpuSelection();
            return;
        }

        try {
            isSubmitting = true;
            updateButtonState();
            setStatus('1. æ­£åœ¨å‡†å¤‡ä¸Šä¼ å‡­è¯...');
            const s3Context = await ensureS3Context();
            const outputKey = generateOutputKey(s3Context.username_prefix);
            const uploadUrl = await s3Client.getSignedUrlPromise('putObject', {
                Bucket: s3Context.bucket_name,
                Key: outputKey,
                ContentType: 'video/mp4',
                Expires: 3600
            });

            const videoUrl = resolveMediaUrl('video');
            const audioUrl = resolveMediaUrl('audio');
            const finalUrl = `${publicBaseUrl}/${outputKey}`;
            const fileName = outputKey.split('/').pop();

            renderResultPreview({ status: 'pending', filename: fileName, output_key: outputKey, public_url: finalUrl });
            if (customGpuTimeoutMs > 0) {
                beginPendingLock(customGpuTimeoutMs, { outputKey, filename: fileName });
            }
            await persistResult(outputKey, fileName, 'pending', finalUrl);

            setStatus('2. æ­£åœ¨è°ƒç”¨ GPU æœåŠ¡...');
            const payload = {
                video_url: videoUrl,
                audio_url: audioUrl,
                output_presigned_url: uploadUrl
            };

            const response = await fetch(selectedConfig.api_url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${selectedConfig.api_token}`
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText || 'GPU æœåŠ¡è°ƒç”¨å¤±è´¥');
            }

            setStatus('3. æ¨¡å‹æ‰§è¡Œå®Œæˆï¼Œæ­£åœ¨æ‹‰å–ç»“æœ...');
            renderResultPreview({ public_url: finalUrl, filename: fileName, output_key: outputKey, status: 'completed' });
            clearPendingLock();
            await persistResult(outputKey, fileName, 'completed', finalUrl);
            setStatus('å¤„ç†å®Œæˆï¼å¦‚æœè§†é¢‘ç¨åæ‰å‡ºç°ï¼Œè¯·åˆ·æ–°æˆ–å‰å¾€â€œæˆ‘çš„ä½œå“â€æŸ¥çœ‹ã€‚');
        } catch (error) {
            console.error('GPU card flow error:', error);
            clearPendingLock();
            showError(error.message || 'æ‰§è¡Œå¤±è´¥ï¼Œè¯·é‡è¯•');
            setStatus('æ‰§è¡Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥è¾“å…¥åé‡è¯•ã€‚');
        } finally {
            isSubmitting = false;
            updateButtonState();
        }
    };

    submitButton.addEventListener('click', handleSubmit);
    updateButtonState();
    if (lastResult) {
        renderResultPreview(lastResult);
        if (lastResult.status === 'pending') {
            resumePendingLockFromServer(lastResult);
        } else if (lastResult.status === 'timeout') {
            setStatus('ä¸Šä¸€æ¬¡ä»»åŠ¡å·²è¶…æ—¶ï¼Œå¯é‡æ–°å°è¯•ã€‚');
        } else {
            setStatus('å·²åŠ è½½æœ€è¿‘ç»“æœ');
        }
    } else {
        setStatus('ç­‰å¾…ä»»åŠ¡å¼€å§‹...');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const spaceType = '{{ space_card_type }}';
    if (spaceType === 'cerebrium') {
        initCustomGpuFlow();
        return;
    } else if (spaceType === 'websocket') {
        initWebSocketFlow();
        return;
    }
    // --- Global State & Elements ---
    let currentTaskId = null;
    let logPollInterval = null;
    let inferenceStatusPollInterval = null;

    const submitButton = document.getElementById('submit-button');
    const timeoutMessage = document.getElementById('timeout-message');
    const aiProjectId = '{{ ai_project.id }}';
    const templates = {{ ai_project.templates | tojson | safe if ai_project.templates else '{}' }};
    const userHasCode = {{ user_has_invitation_code | tojson }};

    const templateSelect = document.getElementById('template-select');
    const paramsContainer = document.getElementById('parameters-container');
    const paramsGrid = document.getElementById('parameters-grid');

    // --- Modal Logic ---
    const modal = document.getElementById('file-browser-modal');
    const selectFileBtn = document.getElementById('select-file-btn');
    const closeBtn = document.querySelector('.close-button');
    const fileListContainer = document.getElementById('file-browser-list');
    const s3ObjectKeysInput = document.getElementById('s3_object_keys');
    const selectedFileDisplay = document.getElementById('selected-file-display');
    const savedFileKey = {{ selected_file_key | tojson }};

    selectFileBtn.addEventListener('click', async () => {
        modal.style.display = 'flex';
        fileListContainer.innerHTML = '<p>æ­£åœ¨åŠ è½½æ–‡ä»¶...</p>';
        try {
            const response = await fetch('{{ url_for("api.list_my_s3_files") }}');
            const data = await response.json();
            if (data.success) {
                const currentSelectedKey = s3ObjectKeysInput.value ? JSON.parse(s3ObjectKeysInput.value)[0] : null;
                renderFileList(data.files, currentSelectedKey);
            } else {
                fileListContainer.innerHTML = `<p style="color: red;">æ— æ³•åŠ è½½æ–‡ä»¶: ${data.error}</p>`;
            }
        } catch (error) {
            fileListContainer.innerHTML = `<p style="color: red;">åŠ è½½æ–‡ä»¶æ—¶å‡ºé”™: ${error.message}</p>`;
        }
    });

    closeBtn.addEventListener('click', () => {
        modal.style.display = 'none';
    });

    window.addEventListener('click', (event) => {
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    });

    function renderFileList(files, selectedKey) {
        if (files.length === 0) {
            fileListContainer.innerHTML = '<p>æ–‡ä»¶åº“ä¸­æ²¡æœ‰æ–‡ä»¶ã€‚</p>';
            return;
        }

        const table = document.createElement('table');
        table.className = 'responsive-table';
        table.style = 'width: 100%; border-collapse: collapse;';
        table.innerHTML = `
            <thead>
                <tr>
                    <th style="padding: 15px; text-align: left; border-bottom: 1px solid #ddd; width: 80px;">é¢„è§ˆ</th>
                    <th style="padding: 15px; text-align: left; border-bottom: 1px solid #ddd;">æ–‡ä»¶å</th>
                    <th style="padding: 15px; text-align: left; border-bottom: 1px solid #ddd;">å¤§å°</th>
                    <th style="padding: 15px; text-align: left; border-bottom: 1px solid #ddd;">ä¿®æ”¹æ—¥æœŸ</th>
                    <th style="padding: 15px; text-align: center; border-bottom: 1px solid #ddd;">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        `;

        const tbody = table.querySelector('tbody');
        files.forEach(file => {
            const row = tbody.insertRow();
            if (file.key === selectedKey) {
                row.style.backgroundColor = '#e7f3ff'; // Highlight selected row
            }
            const sizeInMB = file.size / (1024 * 1024);
            const sizeInKB = file.size / 1024;
            let formattedSize;
            if (sizeInMB >= 1) {
                formattedSize = `${sizeInMB.toFixed(2)} MB`;
            } else {
                formattedSize = `${sizeInKB.toFixed(2)} KB`;
            }

            let previewHtml = '';
            if (file.preview_url && (file.is_image || file.is_video)) {
                if (file.is_image) {
                    previewHtml = `<img src="${file.preview_url}" alt="é¢„è§ˆ" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd;">`;
                } else {
                    previewHtml = `<video src="${file.preview_url}#t=0.1" muted loop playsinline style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; background-color:#000;"></video>`;
                }
            } else {
                previewHtml = `<div style="width: 50px; height: 50px; background-color: #f0f0f0; border-radius: 4px; display: flex; align-items: center; justify-content: center; border: 1px solid #ddd;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>
                               </div>`;
            }

            row.innerHTML = `
                <td data-label="é¢„è§ˆ" style="padding: 15px; text-align: center;">${previewHtml}</td>
                <td data-label="æ–‡ä»¶å" style="padding: 15px;">${file.filename}</td>
                <td data-label="å¤§å°" style="padding: 15px;">${formattedSize}</td>
                <td data-label="ä¿®æ”¹æ—¥æœŸ" style="padding: 15px;">${new Date(file.last_modified).toLocaleString()}</td>
                <td data-label="æ“ä½œ" style="padding: 15px; text-align: center;">
                    <button type="button" class="btn btn-primary btn-sm select-file-confirm" data-key="${file.key}" data-filename="${file.filename}">é€‰æ‹©</button>
                </td>
            `;
        });

        fileListContainer.innerHTML = '';
        fileListContainer.appendChild(table);
    }

    fileListContainer.addEventListener('click', async (event) => {
        if (event.target.classList.contains('select-file-confirm')) {
            const fileKey = event.target.dataset.key;
            const filename = event.target.dataset.filename;

            s3ObjectKeysInput.value = JSON.stringify([fileKey]);
            selectedFileDisplay.textContent = `å·²é€‰æ‹©: ${filename}`;
            modal.style.display = 'none';

            // --- Persist selection ---
            try {
                await fetch('{{ url_for("api.save_selected_file") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        s3_key: fileKey,
                        ai_project_id: aiProjectId
                    }),
                });
            } catch (error) {
                console.error('Failed to save file selection:', error);
            }
        }
    });


    // --- Template & Parameter Rendering ---
    function renderParameters(templateId) {
        paramsGrid.innerHTML = '';
        const template = templates[templateId];

        if (!template || !template.params || template.params.length === 0) {
            paramsContainer.style.display = 'none';
            return;
        }

        let paramFormHtml = '';
        template.params.forEach(param => {
            const name = param.name || '';
            const label = param.label || name;
            const param_type = param.type || 'text';
            const defaultValue = param.default || '';
            const help_text = param.help_text || '';

            let input_html = '';
            if (param_type === 'boolean') {
                const checked = defaultValue ? 'checked' : '';
                input_html = `<input type="checkbox" name="${name}" id="param_${name}" ${checked} style="width: auto;">`;
            } else {
                input_html = `<input type="${param_type}" name="${name}" id="param_${name}" value="${defaultValue}" class="form-control" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">`;
            }

            const help_html = help_text ? `<small style="color: #666; display: block; margin-top: 4px;">${help_text}</small>` : '';

            paramFormHtml += `
                <div class="form-group">
                    <label for="param_${name}">${label}</label>
                    ${input_html}
                    ${help_html}
                </div>
            `;
        });

        paramsGrid.innerHTML = paramFormHtml;
        paramsContainer.style.display = 'block';
    }

    function populateTemplateDropdown() {
        const templateIds = Object.keys(templates);
        let hasRestrictedTemplates = false;

        if (templateIds.length === 0) {
            templateSelect.innerHTML = '<option value="">-- æ­¤Spaceæ— å¯ç”¨GPU --</option>';
            templateSelect.disabled = true;
            setButtonState(true, '<span>ğŸš«</span>æ— å¯ç”¨GPU');
            return;
        }

        templateSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹©ä¸€ä¸ªGPU --</option>';
        templateIds.forEach(id => {
            const template = templates[id];
            const option = document.createElement('option');
            option.value = id;

            const requiresCode = template.requires_invitation_code || false;
            if (requiresCode) {
                hasRestrictedTemplates = true;
            }

            if (requiresCode && !userHasCode) {
                option.textContent = `${template.name} (ğŸ”’ éœ€è¦é‚€è¯·ç )`;
                option.disabled = true;
                option.style.color = '#999';
            } else {
                option.textContent = template.name;
            }
            templateSelect.appendChild(option);
        });

        if (hasRestrictedTemplates && !userHasCode) {
            document.getElementById('invitation-nag-message').style.display = 'block';
        }

        templateSelect.addEventListener('change', function() {
            const selectedId = this.value;
            const isLoggedIn = {{ session.get('logged_in')|tojson }};

            if (selectedId) {
                const template = templates[selectedId];
                const templateName = template.name.toLowerCase();

                // Check for GPU template and user login status
                if (templateName.includes('gpu') && !isLoggedIn) {
                    alert('é€‰æ‹©é«˜çº§GPUéœ€è¦ç™»å½•ã€‚æ‚¨å¯ä»¥ç‚¹å‡»é¡µé¢å³ä¸Šè§’çš„æŒ‰é’®è¿›è¡Œç™»å½•æˆ–æ³¨å†Œã€‚');
                    this.value = ''; // Reset selection
                    return; // Stop further processing
                }

                localStorage.setItem(`selected_template_${aiProjectId}`, selectedId);
                const fileUploadContainer = document.getElementById('file-upload-container');
                const fileUploadLabel = document.getElementById('file-upload-label');
                const promptGroup = document.getElementById('prompt-group');
                const promptTextarea = document.getElementById('prompt');

                renderParameters(selectedId);

                if (template) {
                    // Handle prompt display
                    if (template.disable_prompt) {
                        promptGroup.style.display = 'none';
                        promptTextarea.required = false;
                    } else {
                        promptGroup.style.display = 'block';
                        promptTextarea.required = true;
                    }

                    // Handle file upload display and label
                    if (template.force_upload || template.enable_lora_upload) {
                        fileUploadContainer.style.display = 'block';
                    } else {
                        fileUploadContainer.style.display = 'none';
                    }

                    if (template.enable_lora_upload) {
                        fileUploadLabel.textContent = 'ä¸Šä¼ æ–‡ä»¶ (æ”¯æŒ LoRA, æœ€å¤š2ä¸ª)';
                    } else {
                        fileUploadLabel.textContent = template.force_upload ? 'ä¸Šä¼ æ–‡ä»¶ (å¿…é¡»)' : 'ä¸Šä¼ æ–‡ä»¶';
                    }

                    // Handle file types for selection
                    // This is a placeholder for where you would adjust the file input's `accept` attribute
                    // if you were using a direct <input type="file">.
                    // Since we use a modal, the filtering happens when listing files.
                    // For now, we just note that .glb should be allowed.
                    const fileInput = document.querySelector('input[type="file"]'); // Hypothetical input
                    if (fileInput) {
                        let acceptTypes = 'image/*,video/*';
                        if (template.force_upload) {
                             acceptTypes += ',.glb';
                        }
                         fileInput.accept = acceptTypes;
                    }

                } else {
                    promptGroup.style.display = 'block';
                    promptTextarea.required = true;
                    fileUploadContainer.style.display = 'none';
                }

            } else {
                paramsContainer.style.display = 'none';
                paramsGrid.innerHTML = '';
                fileUploadContainer.style.display = 'none';
                document.getElementById('prompt-group').style.display = 'block';
                document.getElementById('prompt').required = true;
            }
        });

        const savedTemplateId = localStorage.getItem(`selected_template_${aiProjectId}`);
        const savedOption = templateSelect.querySelector(`option[value="${savedTemplateId}"]`);
        if (savedTemplateId && savedOption && !savedOption.disabled) {
            templateSelect.value = savedTemplateId;
            templateSelect.dispatchEvent(new Event('change'));
        }
    }


    // --- Form Submission & Status Polling ---
    function setButtonState(disabled, message = '<span>ğŸš€</span>å¼€å§‹ç”Ÿæˆ') {
        submitButton.disabled = disabled;
        submitButton.innerHTML = message;
        submitButton.style.cursor = disabled ? 'not-allowed' : 'pointer';
        submitButton.style.opacity = disabled ? '0.6' : '1';
    }

    async function checkInferenceStatus() {
        try {
            const response = await fetch('{{ url_for("main.check_inference_status") }}');
            const result = await response.json();
            if (!result.is_waiting) {
                setButtonState(false);
                if (inferenceStatusPollInterval) clearInterval(inferenceStatusPollInterval);
            } else {
                setButtonState(true, '<span class="loading"></span>æ­£åœ¨ç”Ÿæˆ...');
            }
        } catch (error) {
            console.error('æ— æ³•æ£€æŸ¥æ¨ç†çŠ¶æ€:', error);
            setButtonState(false);
            if (inferenceStatusPollInterval) clearInterval(inferenceStatusPollInterval);
        }
    }

    document.getElementById('inference-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const isLoggedIn = {{ session.get('logged_in')|tojson }};
        if (!isLoggedIn) {
            alert('æ‚¨éœ€è¦ç™»å½•æ‰èƒ½è¿è¡Œæ­¤å·¥å…·ã€‚è¯·ç‚¹å‡»é¡µé¢å³ä¸Šè§’çš„æŒ‰é’®è¿›è¡Œç™»å½•æˆ–æ³¨å†Œã€‚');
            return;
        }

        if (!templateSelect.value) {
            alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªGPUã€‚');
            return;
        }
        document.getElementById('error-message').style.display = 'none';
        setButtonState(true, '<span class="loading"></span>æ­£åœ¨å¯åŠ¨...');
        timeoutMessage.style.display = 'none';

        const statusDiv = document.getElementById('status');
        const logsDiv = document.getElementById('logs');
        const resultDiv = document.getElementById('result-content');

        statusDiv.className = 'result-status';
        resultDiv.innerHTML = 'å‡†å¤‡æäº¤ä»»åŠ¡...';
        logsDiv.innerHTML = '';

        // --- Proceed with inference form submission ---
        const formData = new FormData(this);

        resultDiv.innerHTML = 'æ­£åœ¨å¯åŠ¨ä»»åŠ¡...';
        logsDiv.innerHTML = 'æ­£åœ¨å¯åŠ¨...';

        if (logPollInterval) clearInterval(logPollInterval);
        if (inferenceStatusPollInterval) clearInterval(inferenceStatusPollInterval);

        try {
            const response = await fetch('{{ url_for("main.run_inference", ai_project_id=ai_project.id) }}', {
                method: 'POST',
                body: formData
            });
            const result = await response.json();
            if (response.ok) {
                currentTaskId = result.task_id;
                resultDiv.innerHTML = 'ä»»åŠ¡å·²å¯åŠ¨ï¼Œæ­£åœ¨æ‰§è¡Œ...';
                setButtonState(true, '<span class="loading"></span>æ­£åœ¨ç”Ÿæˆ...');
                logPollInterval = setInterval(checkLogStatus, 2000);
                inferenceStatusPollInterval = setInterval(checkInferenceStatus, 3000);
            } else {
                const errorDiv = document.getElementById('error-message');
                errorDiv.innerText = result.error || 'An unknown error occurred.';
                errorDiv.style.display = 'block';
                resultDiv.innerHTML = 'é”™è¯¯: ' + (result.error || 'æœªçŸ¥é”™è¯¯');
                statusDiv.className = 'result-status failed';
                setButtonState(false);
            }
        } catch (error) {
            resultDiv.innerHTML = 'è¯·æ±‚å¤±è´¥: ' + error.message;
            statusDiv.className = 'result-status failed';
            setButtonState(false);
        }
    });

    async function checkLogStatus() {
        if (!currentTaskId) return;
        try {
            const response = await fetch(`{{ url_for('main.check_status', task_id='') }}${currentTaskId}`);
            const task = await response.json();
            const logsDiv = document.getElementById('logs');
            logsDiv.innerHTML = task.logs || 'æš‚æ— æ—¥å¿—...';
            logsDiv.scrollTop = logsDiv.scrollHeight;

            const statusDiv = document.getElementById('status');
            const resultDiv = document.getElementById('result-content');
            if (task.status === 'completed' || task.status === 'failed') {
                if (logPollInterval) clearInterval(logPollInterval);
                statusDiv.className = `result-status ${task.status}`;
                let resultHtml = `<h4>${task.status === 'completed' ? 'âœ… ä»»åŠ¡å®Œæˆ!' : 'âŒ ä»»åŠ¡å¤±è´¥'}</h4>`;
                if (task.status === 'completed' && task.result_files && task.result_files.length > 0) {
                    const objectKey = task.result_files[0];
                    try {
                        const urlResponse = await fetch(`/api/get-s3-view-url?key=${encodeURIComponent(objectKey)}`);
                        const urlData = await urlResponse.json();
                        if (urlData.success) {
                            const resultFileUrl = urlData.url;
                            resultHtml += '<h4>ç»“æœæ–‡ä»¶:</h4>';
                            if (/\.(jpg|jpeg|png|gif|webp)$/i.test(objectKey)) {
                                resultHtml += `<a href="${resultFileUrl}" target="_blank"><img src="${resultFileUrl}" style="max-width: 100%; border-radius: 6px; margin-top: 10px;"></a>`;
                            } else if (/\.(mp4|webm|mov)$/i.test(objectKey)) {
                                resultHtml += `<video src="${resultFileUrl}" controls style="max-width: 100%; border-radius: 6px; margin-top: 10px;"></video>`;
                            } else if (/\.(mp3|wav|ogg)$/i.test(objectKey)) {
                                resultHtml += `<audio src="${resultFileUrl}" controls style="width: 100%; margin-top: 10px;"></audio>`;
                            } else {
                                resultHtml += `<a href="${resultFileUrl}" target="_blank" class="btn btn-secondary" style="margin-top: 10px;">ä¸‹è½½ç»“æœæ–‡ä»¶</a>`;
                            }
                        } else {
                            resultHtml += `<p>æ— æ³•è·å–ç»“æœæ–‡ä»¶çš„é¢„è§ˆé“¾æ¥: ${urlData.error || 'æœªçŸ¥é”™è¯¯'}</p>`;
                        }
                    } catch (e) {
                        resultHtml += `<p>è·å–é¢„è§ˆé“¾æ¥æ—¶å‡ºé”™: ${e.message}</p>`;
                    }
                } else if (task.status === 'completed') {
                    resultHtml += '<p>ä»»åŠ¡å®Œæˆï¼Œä½†æ²¡æœ‰æ‰¾åˆ°è¾“å‡ºæ–‡ä»¶æˆ–æ–‡ä»¶ä¸Šä¼ å¤±è´¥ã€‚</p>';
                } else {
                    resultHtml += '<p>è¯·æŸ¥çœ‹æ—¥å¿—äº†è§£è¯¦ç»†ä¿¡æ¯ã€‚</p>';
                }
                resultDiv.innerHTML = resultHtml;
            } else if (task.status === 'running') {
                statusDiv.className = 'result-status running';
                resultDiv.innerHTML = '<h4>âš¡ æ­£åœ¨æ‰§è¡Œ...</h4><p>è¯·è€å¿ƒç­‰å¾…ä»»åŠ¡å®Œæˆã€‚</p>';
            }
        } catch (error) {
            console.error('çŠ¶æ€æ£€æŸ¥å¤±è´¥:', error);
            if (logPollInterval) clearInterval(logPollInterval);
            document.getElementById('result-content').innerHTML = '<h4>âŒ è¿æ¥é”™è¯¯</h4><p>æ— æ³•è·å–ä»»åŠ¡çŠ¶æ€ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åé‡è¯•ã€‚</p>';
            document.getElementById('status').className = 'result-status failed';
        }
    }

    // --- Initial Page Load Logic ---
    const isWaiting = {{ is_waiting_for_file | tojson }};
    if (isWaiting) {
        setButtonState(true, '<span class="loading"></span>æ­£åœ¨ç”Ÿæˆ...');
        inferenceStatusPollInterval = setInterval(checkInferenceStatus, 3000);
    }

    populateTemplateDropdown();

    if (savedFileKey) {
        s3ObjectKeysInput.value = JSON.stringify([savedFileKey]);
        // Extract filename from the key, which is usually 'username/filename.ext'
        const filename = savedFileKey.split('/').pop();
        selectedFileDisplay.textContent = `å·²é€‰æ‹©: ${filename}`;
    }

    // --- Form Persistence Logic ---
    const promptInput = document.getElementById('prompt');

    // Load prompt from localStorage
    const savedPrompt = localStorage.getItem(`prompt_${aiProjectId}`);
    if (savedPrompt) {
        promptInput.value = savedPrompt;
    }

    // Save prompt to localStorage
    promptInput.addEventListener('input', function() {
        localStorage.setItem(`prompt_${aiProjectId}`, this.value);
    });

    // Save/Load dynamic params using event delegation
    paramsGrid.addEventListener('input', function(e) {
        if (e.target.name) {
            const key = `param_${aiProjectId}_${templateSelect.value}_${e.target.name}`;
            localStorage.setItem(key, e.target.value);
        }
    });

    templateSelect.addEventListener('change', function() {
        const selectedId = this.value;
        if (selectedId) {
            // After rendering, try to load saved values
            setTimeout(() => {
                const template = templates[selectedId];
                if (template && template.params) {
                    template.params.forEach(param => {
                        const input = document.getElementById(`param_${param.name}`);
                        if (input) {
                            const key = `param_${aiProjectId}_${selectedId}_${param.name}`;
                            const savedValue = localStorage.getItem(key);
                            if (savedValue !== null) {
                                input.value = savedValue;
                            }
                        }
                    });
                }
            }, 0);
        }
    });

    // --- Clipboard.js Initialization ---
    var clipboard = new ClipboardJS('.copy-button');

    clipboard.on('success', function(e) {
        const originalText = e.trigger.innerHTML;
        e.trigger.innerHTML = 'å·²å¤åˆ¶!';
        setTimeout(function() {
            e.trigger.innerHTML = originalText;
        }, 2000);
        e.clearSelection();
    });

    clipboard.on('error', function(e) {
        console.error('Action:', e.action);
        console.error('Trigger:', e.trigger);
        alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ã€‚');
    });

    // --- API Tabs Logic ---
    document.querySelectorAll('.api-example').forEach(function(exampleContainer) {
        const tabButtons = exampleContainer.querySelectorAll('.api-tab-button');
        const tabContents = exampleContainer.querySelectorAll('.api-tab-content');

        // Activate the first tab by default
        if (tabButtons.length > 0) {
            tabButtons[0].classList.add('active');
            tabContents[0].classList.add('active');
        }

        tabButtons.forEach(function(button) {
            button.addEventListener('click', function() {
                // Deactivate all tabs within this container
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));

                // Activate the clicked tab
                button.classList.add('active');
                const targetContent = exampleContainer.querySelector(button.dataset.tabTarget);
                if (targetContent) {
                    targetContent.classList.add('active');
                }
            });
        });
    });
});
</script>
{% endblock %}
