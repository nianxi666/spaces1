{% extends "layout.html" %}
{% block title %}{{ ai_project.name }} - Shell{% endblock %}

{% block content %}
<div style="max-width: 1200px; margin: 0 auto; padding: 20px;">
    <div style="background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); overflow: hidden;">
        {% if ai_project.cover %}
        <div style="border-bottom: 1px solid #eee;">
            {% set cover_url = ai_project.cover if ai_project.cover.startswith('http') else to_s3_url(ai_project.cover) %}
            {% if ai_project.cover_type == 'video' %}
                <video src="{{ cover_url }}" autoplay muted loop playsinline style="width: 100%; max-height: 360px; object-fit: cover;"></video>
            {% else %}
                <img src="{{ cover_url }}" alt="{{ ai_project.name }} Cover" style="width: 100%; max-height: 360px; object-fit: cover;">
            {% endif %}
        </div>
        {% endif %}

        <div style="padding: 20px; border-bottom: 1px solid #eee; background: #f8f9fa;">
            <h2 style="margin: 0; font-size: 20px; color: #333;">{{ ai_project.name }}</h2>
            <p style="margin: 6px 0 0; color: #666; font-size: 14px;">{{ ai_project.description }}</p>
        </div>

        <div style="padding: 20px;">
            {% if not session.logged_in %}
            <div style="padding: 12px; border-radius: 8px; background: #fff4e5; border: 1px solid #ffe0b2; color: #a65b00; margin-bottom: 20px;">
                该卡片需要登录后才能执行命令，请先 <a href="{{ url_for('auth.login') }}">登录</a> 或 <a href="{{ url_for('auth.register') }}">注册</a>。
            </div>
            {% endif %}

            <div style="display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap; margin-bottom: 12px;">
                <div style="min-width: 240px; flex: 1;">
                    <label style="display:block; margin-bottom:6px; font-weight: 600; color:#333;">请选择一个命令</label>
                    <select id="ws-shell-command" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                        {% if ws_shell_commands %}
                        {% for cmd in ws_shell_commands %}
                        <option value="{{ cmd.id }}">{{ cmd.label }}</option>
                        {% endfor %}
                        {% else %}
                        <option value="">（管理员尚未配置命令）</option>
                        {% endif %}
                    </select>
                </div>

                <button id="ws-shell-run" {% if not session.logged_in or not ws_shell_commands %}disabled{% endif %}
                        style="background: #FF7518; color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; height: 42px;">
                    运行
                </button>

                <button id="ws-shell-clear" type="button"
                        style="background: #f1f1f1; color: #333; border: 1px solid #ddd; padding: 10px 16px; border-radius: 8px; cursor: pointer; height: 42px;">
                    清空输出
                </button>
            </div>

            <div id="ws-shell-error" style="display:none; padding: 10px 12px; border-radius: 8px; background: #ffebee; border: 1px solid #ffcdd2; color: #b71c1c; margin-bottom: 12px;"></div>

            <div style="border: 1px solid #eee; border-radius: 12px; overflow: hidden;">
                <div style="padding: 10px 12px; background: #0d1117; color: #c9d1d9; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size: 12px; border-bottom: 1px solid #30363d;">
                    输出
                </div>
                <pre id="ws-shell-output" style="margin: 0; padding: 12px; background: #0d1117; color: #c9d1d9; min-height: 280px; max-height: 520px; overflow: auto; white-space: pre-wrap; word-break: break-word; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size: 12px;"></pre>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const spaceId = "{{ ai_project.id }}";
    const runBtn = document.getElementById('ws-shell-run');
    const clearBtn = document.getElementById('ws-shell-clear');
    const commandSelect = document.getElementById('ws-shell-command');
    const outputEl = document.getElementById('ws-shell-output');
    const errorEl = document.getElementById('ws-shell-error');

    function showError(msg) {
        errorEl.textContent = msg;
        errorEl.style.display = 'block';
    }

    function hideError() {
        errorEl.textContent = '';
        errorEl.style.display = 'none';
    }

    if (clearBtn) {
        clearBtn.addEventListener('click', () => {
            outputEl.textContent = '';
            hideError();
        });
    }

    async function runCommand() {
        hideError();

        const commandId = commandSelect.value;
        const label = commandSelect.options[commandSelect.selectedIndex]?.textContent || commandId;

        if (!commandId) {
            showError('请选择一个命令');
            return;
        }

        runBtn.disabled = true;
        const startAt = new Date().toISOString();
        outputEl.textContent += `\n$ [${startAt}] ${label}\n`;

        try {
            const resp = await fetch('/api/ws-shell/run', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ space_id: spaceId, command_id: commandId })
            });

            const data = await resp.json().catch(() => ({}));

            if (!resp.ok || !data.success) {
                const err = data.error || `请求失败 (${resp.status})`;
                showError(err);
                outputEl.textContent += `!! ${err}\n`;
                return;
            }

            if (data.stdout) outputEl.textContent += data.stdout;
            if (data.stderr) outputEl.textContent += data.stderr;
            outputEl.textContent += `\n(exit_code=${data.exit_code})\n`;
            outputEl.scrollTop = outputEl.scrollHeight;

        } catch (e) {
            showError(e.message || '网络错误');
        } finally {
            runBtn.disabled = false;
        }
    }

    if (runBtn) {
        runBtn.addEventListener('click', runCommand);
    }
});
</script>
{% endblock %}
