{% extends "layout.html" %}
{% block title %}{{ 'ç¼–è¾‘' if space else 'æ·»åŠ ' }} Space{% endblock %}
{% block content %}
{% set netmind_settings = netmind_settings if netmind_settings is defined else None %}
{% set alias_enabled = netmind_settings.enable_alias_mapping if netmind_settings else False %}
<h2 style="color: #333; margin-bottom: 30px;">{{ 'ç¼–è¾‘' if space else 'æ·»åŠ ' }} Space</h2>
<div style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
    <form method="post" id="space-form">
        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">åç§°</label>
            <input type="text" name="name" value="{{ space.name if space else '' }}" required
                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
        </div>
        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">æè¿°</label>
            <textarea name="description"
                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; height: 80px;">{{ space.description if space else '' }}</textarea>
        </div>
        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Space å¡ç‰‡ç±»å‹</label>
            {% set card_type = space.card_type if space else 'remote_inference' %}
            <select name="card_type"
                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">

                <option value="remote_inference" {% if card_type=='remote_inference' %}selected{% endif %}>è¿œç¨‹æ¨ç†å‹ (Remote
                    Inference)</option>
                <option value="netmind" {% if card_type=='netmind' %}selected{% endif %}>æ¨¡å‹ä»£ç†èŠå¤©å‹</option>
            </select>
            <small style="color: #666;">è¿œç¨‹æ¨ç†å‹ç”¨äºè°ƒç”¨è¿œç¨‹ GPU API æœåŠ¡ï¼›èŠå¤©å‹ä¼šé€šè¿‡ä»£ç† API è½¬å‘èŠå¤©è¯·æ±‚ã€‚</small>
        </div>

        <div id="netmind-settings"
            style="margin-bottom: 15px; {% if card_type != 'netmind' %}display: none;{% endif %}">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">å¯¹å¤–å±•ç¤ºçš„æ¨¡å‹ ID</label>
            <input type="text" name="netmind_model"
                value="{{ space.netmind_model if space and space.netmind_model else '' }}"
                placeholder="ä¾‹å¦‚: gpt-4-turbo æˆ– llama-3-70b"
                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
            <small style="color: #666;">è¯·è¾“å…¥é¢å‘å¤–éƒ¨ç”¨æˆ·å±•ç¤ºçš„æ¨¡å‹ IDï¼Œç”¨æˆ·è°ƒç”¨ API / Chat é¡µé¢æ—¶ä¼šä¼ é€’å®ƒã€‚</small>

            <label style="display: block; margin: 15px 0 5px; font-weight: bold;">ä¸Šæ¸¸æ¨¡å‹ ID</label>
            <input type="text" name="netmind_upstream_model"
                value="{{ space.netmind_upstream_model if space and space.netmind_upstream_model else (space.netmind_model if space and space.netmind_model else '') }}"
                placeholder="ä¾‹å¦‚: deepseek-chat æˆ– azure-gpt4"
                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; {% if not alias_enabled %}background: #f5f5f5; color: #888;{% endif %}"
                {% if not alias_enabled %}readonly{% endif %}>
            {% if alias_enabled %}
            <small style="color: #666;">è¯¥å€¼ä¸ºéƒ¨ç½²åœ¨æœåŠ¡å™¨ä¸Šçš„çœŸå®æ¨¡å‹ IDã€‚ç³»ç»Ÿä¼šåœ¨è°ƒç”¨ä¸Šæ¸¸æ¥å£æ—¶è‡ªåŠ¨å°†è‡ªå®šä¹‰åç§°æ˜ å°„åˆ°æ­¤ IDã€‚</small>
            {% else %}
            <small style="color: #999;">ç®¡ç†å‘˜å·²å…³é—­æ¨¡å‹æ˜ å°„åŠŸèƒ½ï¼›ä¸Šæ¸¸æ¨¡å‹ ID å°†ä¸ä¸Šæ–¹ä¿æŒä¸€è‡´ã€‚</small>
            {% endif %}
        </div>

        {% set timeout_seconds = space.remote_inference_timeout_seconds if space and
        space.remote_inference_timeout_seconds is not none else 300 %}
        {% set timeout_minutes = (timeout_seconds / 60) | int %}
        <div id="remote-inference-settings"
            style="margin-bottom: 15px; {% if card_type != 'remote_inference' %}display: none;{% endif %}">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">æ¨ç†è¶…æ—¶æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰</label>
            <input type="number" name="remote_inference_timeout_minutes" min="1" value="{{ timeout_minutes }}"
                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
            <small style="color: #666;">å½“ç”¨æˆ·å‘èµ·è¿œç¨‹æ¨ç†åï¼Œåœ¨è¯¥æ—¶é—´å†…è‹¥æœªæ”¶åˆ°ç»“æœä¼šæç¤ºè¶…æ—¶ï¼Œå¹¶å…è®¸é‡æ–°å‘é€ã€‚</small>

            <label style="display: block; margin-top: 15px; margin-bottom: 5px; font-weight: bold;">è‡ªå®šä¹‰APIåœ°å€ï¼ˆå¯é€‰ï¼‰</label>
            <input type="url" name="custom_api_url"
                value="{{ space.custom_api_url if space and space.custom_api_url else '' }}"
                placeholder="ä¾‹å¦‚: http://direct.virtaicloud.com:21564/api/generate"
                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
            <small style="color: #666;">ç•™ç©ºåˆ™ä½¿ç”¨é»˜è®¤APIã€‚å¡«å†™åå°†è°ƒç”¨æ­¤è‡ªå®šä¹‰APIåœ°å€ã€‚</small>


            <label style="display: block; margin-top: 15px; margin-bottom: 10px; font-weight: bold;">å¯ç”¨è¾“å…¥é€‰é¡¹
                (å¼ºåˆ¶ç”Ÿæ•ˆ)</label>
            <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 5px;">
                <div style="display: flex; flex-direction: column; width: 120px;">
                    <label style="font-size: 12px; color: #666; margin-bottom: 4px;">æç¤ºè¯</label>
                    <select name="enable_prompt" style="padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="true" {% if not space or space.get('enable_prompt', True) %}selected{% endif %}>
                            å¯ç”¨</option>
                        <option value="false" {% if space and not space.get('enable_prompt', True) %}selected{% endif
                            %}>ç¦ç”¨</option>
                    </select>
                </div>

                <div style="display: flex; flex-direction: column; width: 120px;">
                    <label style="font-size: 12px; color: #666; margin-bottom: 4px;">å›¾ç‰‡ä¸Šä¼ </label>
                    <select name="enable_image_input" style="padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="true" {% if space and space.get('enable_image_input', False) %}selected{% endif
                            %}>å¯ç”¨</option>
                        <option value="false" {% if not space or not space.get('enable_image_input', False) %}selected{%
                            endif %}>ç¦ç”¨</option>
                    </select>
                </div>

                <div style="display: flex; flex-direction: column; width: 120px;">
                    <label style="font-size: 12px; color: #666; margin-bottom: 4px;">éŸ³é¢‘ä¸Šä¼ </label>
                    <select name="enable_audio_input" style="padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="true" {% if space and space.get('enable_audio_input', False) %}selected{% endif
                            %}>å¯ç”¨</option>
                        <option value="false" {% if not space or not space.get('enable_audio_input', False) %}selected{%
                            endif %}>ç¦ç”¨</option>
                    </select>
                </div>

                <div style="display: flex; flex-direction: column; width: 120px;">
                    <label style="font-size: 12px; color: #666; margin-bottom: 4px;">æ–‡ä»¶ä¸Šä¼ </label>
                    <select name="enable_file_input" style="padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="true" {% if space and space.get('enable_file_input', False) %}selected{% endif
                            %}>å¯ç”¨</option>
                        <option value="false" {% if not space or not space.get('enable_file_input', False) %}selected{%
                            endif %}>ç¦ç”¨</option>
                    </select>
                </div>
            </div>
            <small style="color: #666;">ä½¿ç”¨ä¸‹æ‹‰èœå•å¼ºåˆ¶è¦†ç›–é…ç½®ã€‚è¯·é€‰æ‹©"å¯ç”¨"æˆ–"ç¦ç”¨"ã€‚</small>
        </div>
        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">å°é¢å›¾ç‰‡</label>
            <div style="display: flex; flex-direction: column; gap: 5px;">
                <input type="file" id="cover_file_input" accept="image/*,video/*"
                    style="padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                <button type="button" id="select-cover-btn" class="btn btn-secondary"
                    style="width: fit-content;">ä»æˆ‘çš„ä½œå“ä¸­é€‰æ‹©</button>
            </div>
            <input type="hidden" name="cover" id="cover_url_input" value="{{ space.cover if space else '' }}">
            <input type="hidden" name="cover_type" id="cover_type_input"
                value="{{ space.cover_type if space else 'image' }}">
            <div id="upload-status" style="margin-top: 10px; font-weight: bold;"></div>
            <div id="cover-preview-container"
                style="margin-top: 10px; {% if not space or not space.cover %}display: none;{% endif %}">
                <p style="color: #666; margin: 0;">å½“å‰:</p>
                {% if space and space.cover %}
                {% set cover_url = space.cover if space.cover.startswith('http') else to_s3_url(space.cover) %}
                {% if space.cover_type == 'video' %}
                <video id="cover-preview-video" src="{{ cover_url }}"
                    style="width: 150px; height: auto; vertical-align: middle; border-radius: 4px;" controls></video>
                <img id="cover-preview-img" src=""
                    style="display: none; width: 100px; height: 100px; object-fit: cover; vertical-align: middle; border-radius: 4px;">
                {% else %}
                <video id="cover-preview-video" src=""
                    style="display: none; width: 150px; height: auto; vertical-align: middle; border-radius: 4px;"
                    controls></video>
                <img id="cover-preview-img" src="{{ cover_url }}"
                    style="width: 100px; height: 100px; object-fit: cover; vertical-align: middle; border-radius: 4px;">
                {% endif %}
                {% endif %}
            </div>
        </div>
        <hr style="margin-top: 20px; margin-bottom: 20px; border: 0; border-top: 1px solid #eee;">

        {% if space %}
        <div id="template-management" style="margin-bottom: 20px;">
            <h3 style="color: #333; margin-bottom: 20px;">GPU (GPU)</h3>
            <div id="template-list">
                <p>æ­¤ Space è¿˜æ²¡æœ‰GPUã€‚</p>
            </div>
            <button type="button" id="add-template-btn"
                style="margin-top: 15px; background-color: #28a745; color: white; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer;">+
                æ·»åŠ æ–°GPU</button>
        </div>
        {% else %}
        <div class="alert alert-info"
            style="padding: 15px; background-color: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; border-radius: 4px;">
            è¯·å…ˆä¿å­˜ Spaceï¼Œç„¶åæ‚¨æ‰èƒ½å‘å…¶æ·»åŠ GPUã€‚
        </div>
        {% endif %}

        <br>
        <button type="submit"
            style="background: #dc3545; color: white; padding: 12px 24px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; font-weight: bold; width: 100%; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            ğŸš¨ å¼ºåˆ¶ä¿å­˜é…ç½® (Force Save)
        </button>

    </form>
</div>

<!-- Cover Image Scripts -->
<script>
    // Sync visible checkboxes to hidden inputs (for remote_inference settings)
    document.addEventListener('DOMContentLoaded', function () {
        const checkboxPairs = [
            { cb: 'cb_enable_prompt', hidden: 'hidden_enable_prompt' },
            { cb: 'cb_enable_image_input', hidden: 'hidden_enable_image_input' },
            { cb: 'cb_enable_audio_input', hidden: 'hidden_enable_audio_input' },
            { cb: 'cb_enable_file_input', hidden: 'hidden_enable_file_input' }
        ];

        checkboxPairs.forEach(pair => {
            const checkbox = document.getElementById(pair.cb);
            const hidden = document.getElementById(pair.hidden);

            if (checkbox && hidden) {
                // Update hidden input when checkbox changes
                checkbox.addEventListener('change', function () {
                    hidden.value = this.checked ? 'true' : 'false';
                    console.log(`Updated ${pair.hidden} = ${hidden.value}`);
                });
            }
        });
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const coverFileInput = document.getElementById('cover_file_input');
        const coverUrlInput = document.getElementById('cover_url_input');
        const coverTypeInput = document.getElementById('cover_type_input');
        const uploadStatus = document.getElementById('upload-status');
        const previewContainer = document.getElementById('cover-preview-container');
        const previewImg = document.getElementById('cover-preview-img');
        const previewVideo = document.getElementById('cover-preview-video');
        const spaceId = "{{ space.id if space else '' }}";
        const cardTypeSelect = document.querySelector('select[name="card_type"]');
        const remoteInferenceSettings = document.getElementById('remote-inference-settings');
        const netmindSettings = document.getElementById('netmind-settings');

        if (cardTypeSelect) {
            const toggleSettings = () => {
                const val = cardTypeSelect.value;
                if (remoteInferenceSettings) remoteInferenceSettings.style.display = val === 'remote_inference' ? 'block' : 'none';
                if (netmindSettings) netmindSettings.style.display = val === 'netmind' ? 'block' : 'none';
            };
            cardTypeSelect.addEventListener('change', toggleSettings);
            toggleSettings();
        }

        function updateCoverPreview(url, type) {
            if (!previewContainer) return;
            previewContainer.style.display = 'block';
            if (type === 'video') {
                if (previewImg) {
                    previewImg.style.display = 'none';
                    previewImg.src = '';
                }
                if (previewVideo) {
                    previewVideo.style.display = 'block';
                    previewVideo.src = url;
                }
            } else {
                if (previewVideo) {
                    previewVideo.style.display = 'none';
                    previewVideo.src = '';
                }
                if (previewImg) {
                    previewImg.style.display = 'block';
                    previewImg.src = url;
                }
            }
        }

        if (coverFileInput) {
            coverFileInput.addEventListener('change', async function (event) {
                const file = event.target.files[0];
                if (!file) return;

                uploadStatus.textContent = 'æ­£åœ¨è·å–ä¸Šä¼ è®¸å¯...';
                uploadStatus.style.color = '#007bff';

                try {
                    const presignedUrlResponse = await fetch(`/api/generate-upload-url?fileName=${encodeURIComponent(file.name)}&contentType=${encodeURIComponent(file.type || 'application/octet-stream')}`);
                    if (!presignedUrlResponse.ok) throw new Error('æ— æ³•ä»æœåŠ¡å™¨è·å–ä¸Šä¼ URLã€‚');

                    const data = await presignedUrlResponse.json();
                    if (!data.success) throw new Error(data.error || 'ç”Ÿæˆä¸Šä¼ URLå¤±è´¥ã€‚');

                    const { presigned_url, final_url } = data;
                    uploadStatus.textContent = 'æ­£åœ¨ä¸Šä¼ ...';

                    const uploadResponse = await fetch(presigned_url, {
                        method: 'PUT',
                        body: file,
                        headers: { 'Content-Type': file.type || 'application/octet-stream' }
                    });
                    if (!uploadResponse.ok) throw new Error('ä¸Šä¼ åˆ°S3å¤±è´¥ã€‚');

                    const fileType = file.type.startsWith('video') ? 'video' : 'image';
                    coverUrlInput.value = final_url;
                    coverTypeInput.value = fileType;

                    updateCoverPreview(final_url, fileType);
                    uploadStatus.textContent = 'å°é¢ä¸Šä¼ æˆåŠŸï¼';
                    uploadStatus.style.color = 'green';

                } catch (error) {
                    console.error('Upload failed:', error);
                    uploadStatus.textContent = `ä¸Šä¼ å¤±è´¥: ${error.message}`;
                    uploadStatus.style.color = 'red';
                    coverFileInput.value = '';
                }
            });
        }

        const coverModal = document.getElementById('file-browser-modal');
        const selectCoverBtn = document.getElementById('select-cover-btn');

        if (coverModal && selectCoverBtn && spaceId) {
            const closeBtn = coverModal.querySelector('.close-button');
            const fileListContainer = coverModal.querySelector('#file-browser-list');

            selectCoverBtn.addEventListener('click', async () => {
                coverModal.style.display = 'flex';
                fileListContainer.innerHTML = '<p>æ­£åœ¨åŠ è½½å›¾ç‰‡...</p>';
                try {
                    const response = await fetch('{{ url_for("api.list_my_s3_files") }}');
                    const data = await response.json();
                    if (data.success) {
                        renderFileList(data.files.filter(f => f.is_image));
                    } else {
                        fileListContainer.innerHTML = `<p style="color: red;">æ— æ³•åŠ è½½æ–‡ä»¶: ${data.error}</p>`;
                    }
                } catch (error) {
                    fileListContainer.innerHTML = `<p style="color: red;">åŠ è½½æ–‡ä»¶æ—¶å‡ºé”™: ${error.message}</p>`;
                }
            });

            if (closeBtn) {
                closeBtn.addEventListener('click', () => { coverModal.style.display = 'none'; });
            }

            window.addEventListener('click', (event) => {
                if (event.target == coverModal) coverModal.style.display = 'none';
            });

            function renderFileList(files) {
                if (files.length === 0) {
                    fileListContainer.innerHTML = '<p>æ‚¨è¿˜æ²¡æœ‰ç”Ÿæˆä»»ä½•å›¾ç‰‡ã€‚è¯·å…ˆåœ¨AIç©ºé—´ä¸­åˆ›ä½œã€‚</p>';
                    return;
                }
                fileListContainer.innerHTML = '';
                files.forEach(file => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.dataset.key = file.key;
                    fileItem.innerHTML = `<img src="${file.preview_url}" alt="${file.filename}"><p>${file.filename}</p>`;
                    fileListContainer.appendChild(fileItem);
                });
            }

            if (fileListContainer) {
                fileListContainer.addEventListener('click', async (event) => {
                    const fileItem = event.target.closest('.file-item');
                    if (fileItem) {
                        const fileKey = fileItem.dataset.key;
                        try {
                            const response = await fetch(`/admin/space/${spaceId}/set_cover`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ s3_key: fileKey }),
                            });
                            const result = await response.json();
                            if (result.success) {
                                coverUrlInput.value = result.new_cover_url;
                                coverTypeInput.value = 'image';
                                updateCoverPreview(result.new_cover_url, 'image');
                                coverModal.style.display = 'none';
                                uploadStatus.textContent = 'å°é¢é€‰æ‹©æˆåŠŸï¼';
                                uploadStatus.style.color = 'green';
                            } else {
                                alert('æ›´æ–°å°é¢å¤±è´¥: ' + result.error);
                            }
                        } catch (error) {
                            alert('æ›´æ–°å°é¢æ—¶å‡ºé”™: ' + error.message);
                        }
                    }
                });
            }
        }
    });
</script>

<!-- Template Editor Scripts -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const spaceId = "{{ space.id if space else '' }}";
        if (!spaceId) return;

        const templates = {{ space.templates | tojson | safe if space and space.templates else '{}'
    }};
    let currentEditorMode = 'normal';
    let codeEditor;

    const templateListEl = document.getElementById('template-list');
    const addTemplateBtn = document.getElementById('add-template-btn');
    const templateModal = document.getElementById('template-modal');
    const modalTitle = document.getElementById('modal-title');
    const templateForm = document.getElementById('template-form');
    const cancelBtn = document.getElementById('cancel-template-btn');
    const saveBtn = document.getElementById('save-template-btn');
    const hiddenTemplateIdInput = document.getElementById('template-id');
    const toggleModeBtn = document.getElementById('toggle-mode-btn');

    if (!templateModal) return;

    if (document.getElementById('template-json-editor')) {
        codeEditor = CodeMirror.fromTextArea(document.getElementById('template-json-editor'), {
            mode: { name: "javascript", json: true },
            lineNumbers: true,
            theme: "default",
            autoCloseBrackets: true,
            matchBrackets: true,
        });

        if (toggleModeBtn) {
            toggleModeBtn.addEventListener('click', function () {
                if (currentEditorMode === 'normal') {
                    switchToAdvancedMode();
                } else {
                    switchToNormalMode();
                }
            });
        }
    }

    function switchToAdvancedMode() {
        const templateData = formToJSON();
        codeEditor.setValue(JSON.stringify(templateData, null, 2));
        document.getElementById('normal-editor').style.display = 'none';
        document.getElementById('advanced-editor').style.display = 'block';
        toggleModeBtn.textContent = 'åˆ‡æ¢åˆ°æ™®é€šæ¨¡å¼';
        currentEditorMode = 'advanced';
        codeEditor.refresh();
    }

    function switchToNormalMode() {
        try {
            const jsonData = JSON.parse(codeEditor.getValue());
            jsonToForm(jsonData);
        } catch (e) {
            alert('é«˜çº§æ¨¡å¼ä¸­çš„ä»£ç ä¸æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼ï¼Œè¯·ä¿®æ­£åå†åˆ‡æ¢ã€‚\né”™è¯¯: ' + e.message);
            return;
        }
        document.getElementById('advanced-editor').style.display = 'none';
        document.getElementById('normal-editor').style.display = 'block';
        toggleModeBtn.textContent = 'åˆ‡æ¢åˆ°é«˜çº§æ¨¡å¼';
        currentEditorMode = 'normal';
    }

    const modalParamsContainer = document.getElementById('modal-params-container');
    const modalAddParamBtn = document.getElementById('modal-add-param');
    let currentParams = [];

    function renderModalParams() {
        if (!modalParamsContainer) return;
        modalParamsContainer.innerHTML = '';
        currentParams.forEach((param, index) => {
            const paramEl = document.createElement('div');
            paramEl.className = 'param-item';
            paramEl.style = 'background: #f8f9fa; padding: 15px; border-radius: 6px; border: 1px solid #dee2e6;';
            paramEl.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <strong style="font-size: 1.1em;">å‚æ•° #${index + 1}</strong>
                    <button type="button" class="remove-param" data-index="${index}" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">åˆ é™¤</button>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div><label>åç§°</label><input type="text" class="param-input" data-index="${index}" data-field="name" value="${param.name || ''}" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;"></div>
                    <div><label>æ ‡ç­¾</label><input type="text" class="param-input" data-index="${index}" data-field="label" value="${param.label || ''}" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;"></div>
                    <div><label>ç±»å‹</label><select class="param-input" data-index="${index}" data-field="type" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;"><option value="text" ${param.type === 'text' ? 'selected' : ''}>æ–‡æœ¬</option><option value="number" ${param.type === 'number' ? 'selected' : ''}>æ•°å­—</option><option value="boolean" ${param.type === 'boolean' ? 'selected' : ''}>å¸ƒå°”</option></select></div>
                    <div><label>é»˜è®¤å€¼</label><input type="text" class="param-input" data-index="${index}" data-field="default" value="${param.default || ''}" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;"></div>
                    <div style="grid-column: 1 / -1;"><label>å¸®åŠ©æ–‡æœ¬</label><input type="text" class="param-input" data-index="${index}" data-field="help_text" value="${param.help_text || ''}" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;"></div>
                </div>
            `;
            modalParamsContainer.appendChild(paramEl);
        });
    }

    if (modalAddParamBtn) {
        modalAddParamBtn.addEventListener('click', () => {
            currentParams.push({ name: '', label: '', type: 'text', default: '', help_text: '' });
            renderModalParams();
        });
    }

    if (modalParamsContainer) {
        modalParamsContainer.addEventListener('input', e => {
            if (e.target.classList.contains('param-input')) {
                const index = e.target.dataset.index;
                const field = e.target.dataset.field;
                currentParams[index][field] = e.target.value;
            }
        });
        modalParamsContainer.addEventListener('click', e => {
            if (e.target.classList.contains('remove-param')) {
                currentParams.splice(e.target.dataset.index, 1);
                renderModalParams();
            }
        });
    }

    function formToJSON() {
        const data = {};
        document.querySelectorAll('#normal-editor [name]').forEach(el => {
            if (el.name) {
                if (el.type === 'checkbox') {
                    data[el.name] = el.checked;
                } else if (el.id !== 'modal-params-hidden-input') {
                    data[el.name] = el.value;
                }
            }
        });
        data.params = currentParams;
        return data;
    }

    function jsonToForm(data) {
        document.querySelectorAll('#normal-editor [name]').forEach(el => {
            if (data[el.name] !== undefined && el.id !== 'modal-params-hidden-input') {
                if (el.type === 'checkbox') {
                    el.checked = !!data[el.name];
                } else {
                    el.value = data[el.name];
                }
            }
        });
        currentParams = data.params || [];
        renderModalParams();
    }

    function renderTemplateList() {
        if (!templateListEl) return;
        templateListEl.innerHTML = '';
        if (Object.keys(templates).length === 0) {
            templateListEl.innerHTML = '<p>æ­¤ Space è¿˜æ²¡æœ‰GPUã€‚</p>';
            return;
        }
        const ul = document.createElement('ul');
        ul.style = 'list-style: none; padding: 0;';
        Object.values(templates).sort((a, b) => a.name.localeCompare(b.name)).forEach(t => {
            const li = document.createElement('li');
            li.style = 'background: #f8f9fa; padding: 15px; border-radius: 6px; border: 1px solid #dee2e6; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;';
            li.innerHTML = `
                <div><strong style="font-size: 1.2em;">${t.name}</strong><small style="display: block; color: #6c757d; margin-top: 5px;">ID: ${t.id}</small></div>
                <div>
                    <button type="button" class="edit-template-btn" data-id="${t.id}" style="background: #ffc107; color: #212529; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; margin-right: 5px;">ç¼–è¾‘</button>
                    <button type="button" class="delete-template-btn" data-id="${t.id}" style="background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;">åˆ é™¤</button>
                </div>`;
            ul.appendChild(li);
        });
        templateListEl.appendChild(ul);
    }

    function openEditModal(templateId) {
        const template = templates[templateId];
        if (!template) return;
        modalTitle.textContent = 'ç¼–è¾‘GPU';
        templateForm.reset();
        hiddenTemplateIdInput.value = template.id;
        jsonToForm(template);
        if (currentEditorMode === 'advanced') switchToNormalMode();
        showTemplateModal();
    }

    function openAddModal() {
        modalTitle.textContent = 'æ·»åŠ æ–°GPU';
        templateForm.reset();
        hiddenTemplateIdInput.value = '';
        currentParams = [];
        renderModalParams();
        if (currentEditorMode === 'advanced') switchToNormalMode();
        showTemplateModal();
    }

    function showTemplateModal() { if (templateModal) templateModal.style.display = 'block'; }
    function hideTemplateModal() { if (templateModal) templateModal.style.display = 'none'; }

    if (addTemplateBtn) addTemplateBtn.addEventListener('click', openAddModal);
    if (cancelBtn) cancelBtn.addEventListener('click', hideTemplateModal);

    if (templateListEl) {
        templateListEl.addEventListener('click', function (e) {
            if (e.target.classList.contains('edit-template-btn')) {
                openEditModal(e.target.dataset.id);
            }
            if (e.target.classList.contains('delete-template-btn')) {
                const templateId = e.target.dataset.id;
                if (confirm(`æ‚¨ç¡®å®šè¦åˆ é™¤GPU "${templates[templateId].name}" å—ï¼Ÿ`)) {
                    handleDelete(templateId);
                }
            }
        });
    }

    function handleDelete(templateId) {
        fetch(`/admin/space/${spaceId}/template/delete/${templateId}`, { method: 'POST' })
            .then(res => res.json())
            .then(result => {
                if (result.success) {
                    delete templates[templateId];
                    renderTemplateList();
                } else {
                    alert('Error: ' + result.error);
                }
            }).catch(err => alert('åˆ é™¤GPUæ—¶å‡ºé”™ã€‚'));
    }

    if (saveBtn) {
        saveBtn.addEventListener('click', function (e) {
            e.preventDefault();
            let data;
            if (currentEditorMode === 'advanced') {
                try {
                    data = JSON.parse(codeEditor.getValue());
                } catch (e) {
                    alert('JSONæ ¼å¼æ— æ•ˆ: ' + e.message);
                    return;
                }
            } else {
                data = formToJSON();
            }

            const templateId = hiddenTemplateIdInput.value;
            const url = templateId ? `/admin/space/${spaceId}/template/edit/${templateId}` : `/admin/space/${spaceId}/template/add`;

            saveBtn.disabled = true;
            saveBtn.textContent = 'ä¿å­˜ä¸­...';

            fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
                .then(res => res.json())
                .then(result => {
                    if (result.success) {
                        location.reload();
                    } else {
                        alert('Error: ' + result.error);
                    }
                })
                .catch(err => alert('ä¿å­˜GPUæ—¶å‡ºé”™ã€‚'))
                .finally(() => {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'ä¿å­˜GPU';
                });
        });
    }

    renderTemplateList();

    // Toggle fields based on runner
    if (document.getElementById('template-modal')) {
        const runnerSelect = document.getElementById('command_runner_select');
        if (runnerSelect) {
            runnerSelect.addEventListener('change', updateRunnerFields);
            // Also need to trigger on modal open, which is handled by jsonToForm theoretically,
            // but we need to hook into form reset/load.
            // We can attach a mutation observer or just call it when modal opens.
            // Simplified: Add a listener to the select, and call it when opening modal.
            const addBtn = document.getElementById('add-template-btn');
            if (addBtn) addBtn.addEventListener('click', () => setTimeout(updateRunnerFields, 50));
            const listEl = document.getElementById('template-list');
            if (listEl) listEl.addEventListener('click', (e) => {
                if (e.target.classList.contains('edit-template-btn')) setTimeout(updateRunnerFields, 50);
            });
        }

        function updateRunnerFields() {
            const runner = document.getElementById('command_runner_select').value;
            const fields = document.querySelectorAll('.runner-field');
            const baseLabel = document.getElementById('base_command_label');
            const baseHelp = document.getElementById('base_command_help');

            fields.forEach(f => {
                if (f.classList.contains(`runner-field-${runner}`)) {
                    f.style.display = 'block';
                } else if (f.classList.contains('runner-field-inferless') && runner === 'inferless') {
                    f.style.display = 'block';
                } else if (f.classList.contains('runner-field-modal') && runner === 'modal') {
                    f.style.display = 'block';
                } else {
                    f.style.display = 'none';
                }
            });

            // Special handling because we used shared classes above for brevity but logic is specific
            // Actually, let's just hide all `runner-field` by default and show based on logic.
            fields.forEach(f => f.style.display = 'none');

            if (runner === 'gradio_client') {
                baseLabel.textContent = 'API åœ°å€ (URL)';
                baseHelp.textContent = 'è¯·è¾“å…¥è¿œç¨‹ Gradio æœåŠ¡çš„å®Œæ•´ URLï¼Œä¾‹å¦‚ http://1.2.3.4:7860';
                // Gradio client doesn't need other fields visible
            } else {
                baseLabel.textContent = 'åŸºç¡€å‘½ä»¤';
                baseHelp.textContent = '';
                // Show standard fields
                fields.forEach(f => {
                    if (f.classList.contains('runner-field-inferless') || f.classList.contains('runner-field-modal')) {
                        f.style.display = 'block';
                    }
                });
            }
        }
    }
});
</script>

<style>
    /* Modal Styles copied from profile.html */
    .modal {
        position: fixed;
        z-index: 1050;
        /* Higher than other elements */
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background-color: #fefefe;
        margin: auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 900px;
        border-radius: 8px;
        box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2);
        display: flex;
        flex-direction: column;
        max-height: 90vh;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #ddd;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }

    .modal-header h2 {
        margin: 0;
        font-size: 24px;
    }

    .close-button {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }

    .close-button:hover,
    .close-button:focus {
        color: black;
    }

    .modal-body {
        overflow-y: auto;
    }

    .file-list-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 16px;
    }

    .file-item {
        cursor: pointer;
        border: 2px solid transparent;
        border-radius: 8px;
        padding: 8px;
        text-align: center;
    }

    .file-item:hover {
        border-color: #007bff;
    }

    .file-item img {
        width: 100%;
        height: 120px;
        object-fit: cover;
        border-radius: 4px;
    }

    .file-item p {
        margin: 8px 0 0;
        font-size: 14px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
</style>

<!-- File Browser Modal -->
<div id="file-browser-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>ä»æˆ‘çš„ä½œå“ä¸­é€‰æ‹©å°é¢</h2>
            <span class="close-button">&times;</span>
        </div>
        <div class="modal-body">
            <div id="file-browser-list" class="file-list-container">
                <p>æ­£åœ¨åŠ è½½æ–‡ä»¶...</p>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Template Modal -->
<div id="template-modal"
    style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
    <div
        style="background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 700px; border-radius: 8px; box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2);">
        <h4 id="modal-title">æ·»åŠ æ–°GPU</h4>
        <form id="template-form">
            <div style="text-align: right; margin-bottom: 10px;">
                <button type="button" id="toggle-mode-btn" class="btn btn-secondary btn-sm">åˆ‡æ¢åˆ°é«˜çº§æ¨¡å¼</button>
            </div>
            <div id="normal-editor">
                <input type="hidden" id="template-id" name="template_id">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">GPUåç§°</label>
                    <input type="text" name="template_name" required
                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">å‘½ä»¤è¿è¡Œå™¨</label>
                    <select name="command_runner" id="command_runner_select"
                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                        <option value="gradio_client">Remote Gradio (è¿œç¨‹æ¨ç†)</option>
                        <option value="custom">è‡ªå®šä¹‰å‘½ä»¤</option>
                    </select>
                </div>
                <div class="runner-field runner-field-inferless runner-field-modal" style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">å…¥å£è„šæœ¬ (Entrypoint
                        Script)</label>
                    <input type="text" name="entrypoint_script"
                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-family: monospace;"
                        placeholder="app.py">
                    <small style="color: #666;">è¿è¡Œå‘½ä»¤æ—¶è¦æ‰§è¡Œçš„è„šæœ¬æ–‡ä»¶ï¼Œä¾‹å¦‚ `app.py` æˆ– `gradio.py`ã€‚</small>
                </div>
                <div class="runner-field runner-field-inferless runner-field-modal" style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">ä¸»å‘½ä»¤å‰ç½® (å¯é€‰)</label>
                    <input type="text" name="pre_command"
                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-family: monospace;"
                        placeholder="ä¾‹å¦‚: cd flux &&">
                </div>
                <div class="runner-field runner-field-inferless runner-field-modal" style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">å­å‘½ä»¤å‰ç½® (å¯é€‰)</label>
                    <input type="text" name="sub_command"
                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-family: monospace;"
                        placeholder="ä¾‹å¦‚: cd workspace &&">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;"
                        id="base_command_label">åŸºç¡€å‘½ä»¤</label>
                    <input type="text" name="base_command" required
                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-family: monospace;">
                    <small id="base_command_help" style="color: #666;"></small>
                </div>
                <div class="runner-field runner-field-inferless runner-field-modal" style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">é¢„è®¾å‚æ•° (ç®¡ç†å‘˜å®šä¹‰)</label>
                    <input type="text" name="preset_params"
                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-family: monospace;"
                        placeholder="ä¾‹å¦‚: --height 720 --width 1280">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">é¢„æµ‹è¾“å‡ºæ–‡ä»¶å (å¯é€‰)</label>
                    <input type="text" name="predicted_output_filename"
                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-family: monospace;"
                        placeholder="ä¾‹å¦‚: output.wav">
                    <small style="color: #666;">å¦‚æœç•™ç©ºï¼Œå°†æ ¹æ®promptå’Œseedè‡ªåŠ¨ç”Ÿæˆæ–‡ä»¶åã€‚å¯ä»¥åŒ…å«è·¯å¾„ï¼Œä¾‹å¦‚ `assets/output.glb`ï¼Œå¦åˆ™å°†é»˜è®¤ä¿å­˜åœ¨
                        `output/` ç›®å½•ä¸‹ã€‚</small>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: bold;">é™„åŠ å‚æ•°GPU</label>
                    <div id="modal-params-container" style="display: flex; flex-direction: column; gap: 15px;"></div>
                    <button type="button" id="modal-add-param"
                        style="margin-top: 15px; background-color: #28a745; color: white; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer;">+
                        æ·»åŠ å‚æ•°</button>
                    <input type="hidden" name="params" id="modal-params-hidden-input">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">è¶…æ—¶æ—¶é—´ (ç§’)</label>
                    <input type="number" name="timeout" value="300"
                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">å¼ºåˆ¶ä¸Šä¼ æ–‡ä»¶</label>
                    <input type="checkbox" name="force_upload" style="width: auto;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">å¼€å¯ Lora ä¸Šä¼ </label>
                    <input type="checkbox" name="enable_lora_upload" style="width: auto;">
                    <small style="color: #666;">å¦‚æœé€‰ä¸­ï¼Œå°†å…è®¸ä¸Šä¼ ä¸€ä¸ªé¢å¤–çš„ lora safetensors æ–‡ä»¶ã€‚</small>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">å…³é—­æç¤ºè¯</label>
                    <input type="checkbox" name="disable_prompt" style="width: auto;">
                    <small style="color: #666;">å¦‚æœé€‰ä¸­ï¼Œè¯¥æ¨¡æ¿å°†ä¸å†æœ‰æç¤ºè¯è¾“å…¥åŠŸèƒ½ã€‚</small>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">éœ€è¦é‚€è¯·ç </label>
                    <input type="checkbox" name="requires_invitation_code" style="width: auto;">
                    <small style="color: #666;">å¦‚æœé€‰ä¸­ï¼Œåªæœ‰æ‹¥æœ‰é‚€è¯·ç çš„ç”¨æˆ·æ‰èƒ½ä½¿ç”¨æ­¤GPUã€‚</small>
                </div>
            </div> <!-- closes normal-editor -->
            <div id="advanced-editor" style="display: none;">
                <div style="margin-bottom: 15px;">
                    <label for="template-json-editor"
                        style="display: block; margin-bottom: 5px; font-weight: bold;">æ¨¡æ¿ä»£ç  (JSON)</label>
                    <textarea id="template-json-editor"
                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-family: monospace; height: 300px;"></textarea>
                </div>
            </div>

            <div style="text-align: right;">
                <button type="button" id="cancel-template-btn"
                    style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">å–æ¶ˆ</button>
                <button type="submit" id="save-template-btn"
                    style="background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">ä¿å­˜GPU</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}