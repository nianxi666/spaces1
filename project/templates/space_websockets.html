{% extends "layout.html" %}
{% block title %}{{ ai_project.name }} - WebSocket æ¨ç†{% endblock %}
{% block content %}
<div style="max-width: 1200px; margin: 0 auto; padding: 20px;">
    {% if announcement.enabled and announcement.show_on_projects %}
    <div style="margin-bottom: 20px; padding: 15px; background-color: 
        {% if announcement.type == 'warning' %}#fff3cd
        {% elif announcement.type == 'error' %}#f8d7da
        {% elif announcement.type == 'success' %}#d4edda
        {% else %}#d1ecf1{% endif %};
        border: 1px solid 
        {% if announcement.type == 'warning' %}#ffeaa7
        {% elif announcement.type == 'error' %}#f5c6cb
        {% elif announcement.type == 'success' %}#c3e6cb
        {% else %}#bee5eb{% endif %};
        border-radius: 4px; color: #333;">
        <strong>ğŸ“¢ {{ announcement.title }}</strong><br>
        {{ announcement.content }}
    </div>
    {% endif %}

    <div
        style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 30px;">
        <h1 style="margin-top: 0; color: #333;">{{ ai_project.name }}</h1>
        <p style="color: #666; font-size: 1.1em;">{{ ai_project.description }}</p>

        {% if session.is_admin %}
        <div
            style="background: #f0f8ff; padding: 15px; border-radius: 6px; border-left: 4px solid #0066cc; margin: 20px 0;">
            <strong style="color: #0066cc;">ğŸ“¡ è¿æ¥çŠ¶æ€</strong><br>
            {% if is_connected %}
            <span style="color: green; font-weight: bold;">âœ“ å·²è¿æ¥</span>
            {% if queue_list %}
            <p style="margin: 10px 0 0 0; color: #666;">å½“å‰é˜Ÿåˆ— ({{ queue_size }}äºº):</p>
            <ul style="margin: 5px 0 0 10px; padding-left: 15px; color: #444;">
                {% for item in queue_list %}
                <li>ç¬¬{{ item.position }}ä½: <strong>{{ item.username }}</strong></li>
                {% endfor %}
            </ul>
            {% else %}
            <p style="margin: 10px 0 0 0; color: #666;">é˜Ÿåˆ—ç©ºé—²ï¼Œæ— ç­‰å¾…è¯·æ±‚</p>
            {% endif %}
            {% else %}
            <span style="color: orange; font-weight: bold;">â³ ç­‰å¾…è¿æ¥</span>
            <p style="margin: 10px 0 0 0; color: #666;">è¿œç¨‹æœåŠ¡æœªè¿æ¥</p>
            {% endif %}
        </div>
        {% elif not is_connected %}
        <div
            style="background: #fff3cd; padding: 15px; border-radius: 6px; border-left: 4px solid #ffc107; margin: 20px 0;">
            <strong style="color: #856404;">â³ æœåŠ¡æš‚æ—¶ä¸å¯ç”¨</strong>
            <p style="margin: 10px 0 0 0; color: #666;">è¯·ç¨åå†è¯•ã€‚</p>
        </div>
        {% endif %}

        {% if is_connected and current_username %}
        <div style="margin-top: 30px; padding: 20px; background: #f9f9f9; border-radius: 6px; border: 1px solid #ddd;">
            <h3 style="margin-top: 0; color: #333;">å‘é€æ¨ç†è¯·æ±‚</h3>

            <form id="inference-form" style="display: flex; flex-direction: column; gap: 15px;">
                {% if ai_project.websockets_config and ai_project.websockets_config.enable_prompt %}
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">æç¤ºè¯</label>
                    <textarea name="prompt" id="prompt-input" rows="4" placeholder="è¾“å…¥ä½ çš„æç¤ºè¯..."
                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-family: Arial, sans-serif;"></textarea>
                </div>
                {% endif %}

                {% if ai_project.websockets_config and ai_project.websockets_config.enable_audio %}
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">éŸ³é¢‘ç›´é“¾</label>
                    <input type="url" name="audio_url" id="audio-input" placeholder="https://example.com/audio.wav"
                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                    <small style="color: #666;">è¾“å…¥éŸ³é¢‘æ–‡ä»¶çš„ç›´é“¾åœ°å€</small>
                </div>
                {% endif %}

                {% if ai_project.websockets_config and ai_project.websockets_config.enable_video %}
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">è§†é¢‘æ–‡ä»¶</label>
                    <input type="file" name="video_file" id="video-input" accept="video/*"
                        style="padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    <small style="color: #666;">æ”¯æŒæ ¼å¼: MP4, WebM, MOV ç­‰</small>
                </div>
                {% endif %}

                {% if ai_project.websockets_config and ai_project.websockets_config.enable_file_upload %}
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">å…¶ä»–æ–‡ä»¶</label>
                    <input type="file" name="other_file" id="file-input"
                        style="padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                {% endif %}

                <button type="submit"
                    style="background: #007bff; color: white; padding: 12px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; font-weight: bold;">
                    å‘é€è¯·æ±‚
                </button>
            </form>

            <div id="request-status"
                style="margin-top: 20px; display: none; padding: 15px; background: #e3f2fd; border-radius: 4px; border-left: 4px solid #1976d2;">
                <strong style="color: #1976d2;">å¤„ç†ä¸­...</strong>
                <p style="margin: 10px 0 0 0; color: #555;" id="status-message">æ­£åœ¨å‘é€è¯·æ±‚åˆ°è¿œç¨‹åº”ç”¨...</p>
                <div id="progress-bar"
                    style="margin-top: 10px; height: 4px; background: #ccc; border-radius: 2px; overflow: hidden;">
                    <div style="height: 100%; background: #1976d2; width: 30%; animation: progress 2s infinite;"></div>
                </div>
            </div>

            <div id="request-result"
                style="margin-top: 20px; display: none; padding: 15px; background: #f1f8e9; border-radius: 4px; border-left: 4px solid #689f38;">
                <strong style="color: #689f38;">âœ“ è¯·æ±‚å®Œæˆ</strong>
                <pre id="result-content"
                    style="background: white; padding: 10px; border-radius: 4px; overflow-x: auto; margin-top: 10px; max-height: 300px;"></pre>
            </div>

            <div id="request-error"
                style="margin-top: 20px; display: none; padding: 15px; background: #ffebee; border-radius: 4px; border-left: 4px solid #d32f2f;">
                <strong style="color: #d32f2f;">âœ— é”™è¯¯</strong>
                <p id="error-message" style="margin: 10px 0 0 0; color: #555;"></p>
            </div>
        </div>
        {% elif is_connected and not current_username %}
        <div
            style="margin-top: 30px; padding: 20px; background: #fff3cd; border-radius: 6px; border: 1px solid #ffeaa7; text-align: center;">
            <p style="margin: 0;">è¯·<a href="{{ url_for('auth.login') }}"
                    style="color: #0066cc; text-decoration: none;"><strong>ç™»å½•</strong></a>ä»¥å‘é€æ¨ç†è¯·æ±‚</p>
        </div>
        {% endif %}
    </div>
</div>

<style>
    @keyframes progress {
        0% {
            width: 0%;
        }

        50% {
            width: 100%;
        }

        100% {
            width: 100%;
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('inference-form');
        if (!form) return;

        form.addEventListener('submit', async function (e) {
            e.preventDefault();

            // éªŒè¯éŸ³é¢‘URL
            const audioInput = document.getElementById('audio-input');
            if (audioInput && !audioInput.value.trim()) {
                alert('è¯·è¾“å…¥éŸ³é¢‘ç›´é“¾');
                return;
            }

            const formData = new FormData(form);
            const statusDiv = document.getElementById('request-status');
            const resultDiv = document.getElementById('request-result');
            const errorDiv = document.getElementById('request-error');
            const statusMsg = document.getElementById('status-message');

            statusDiv.style.display = 'block';
            resultDiv.style.display = 'none';
            errorDiv.style.display = 'none';
            statusMsg.textContent = 'æ­£åœ¨å‘é€è¯·æ±‚åˆ°è¿œç¨‹åº”ç”¨...';

            try {
                const response = await fetch('/websockets/submit/{{ ai_project.id }}', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'è¯·æ±‚å¤±è´¥');
                }

                const requestId = data.request_id;
                statusMsg.textContent = `è¯·æ±‚å·²æäº¤ (ID: ${requestId})ï¼Œæ­£åœ¨ç­‰å¾…è¿œç¨‹åº”ç”¨å¤„ç†...`;

                // Poll for result
                let attempts = 0;
                const maxAttempts = 120; // 2 minutes with 1 second interval

                const pollResult = setInterval(async () => {
                    attempts++;
                    try {
                        const statusResponse = await fetch(`/websockets/status?request_id=${requestId}`);
                        const statusData = await statusResponse.json();

                        if (statusData.status === 'completed') {
                            clearInterval(pollResult);
                            statusDiv.style.display = 'none';
                            resultDiv.style.display = 'block';
                            document.getElementById('result-content').textContent = JSON.stringify(statusData.result, null, 2);
                        } else if (statusData.status === 'failed') {
                            clearInterval(pollResult);
                            statusDiv.style.display = 'none';
                            errorDiv.style.display = 'block';
                            document.getElementById('error-message').textContent = statusData.result?.error || 'è¯·æ±‚å¤„ç†å¤±è´¥';
                        } else if (attempts >= maxAttempts) {
                            clearInterval(pollResult);
                            statusDiv.style.display = 'none';
                            errorDiv.style.display = 'block';
                            document.getElementById('error-message').textContent = 'è¯·æ±‚è¶…æ—¶ï¼ˆ2åˆ†é’Ÿï¼‰';
                        }
                    } catch (err) {
                        if (attempts >= maxAttempts) {
                            clearInterval(pollResult);
                            statusDiv.style.display = 'none';
                            errorDiv.style.display = 'block';
                            document.getElementById('error-message').textContent = 'æ— æ³•æ£€æŸ¥è¯·æ±‚çŠ¶æ€';
                        }
                    }
                }, 1000);

            } catch (error) {
                statusDiv.style.display = 'none';
                errorDiv.style.display = 'block';
                document.getElementById('error-message').textContent = error.message;
            }
        });
    });
</script>
{% endblock %}