{% extends "layout.html" %}
{% block title %}会员系统设置 - 管理面板{% endblock %}
{% block content %}
<div class="max-w-4xl mx-auto pb-12">
    <div class="flex items-center gap-4 mb-6">
        <a href="{{ url_for('admin.admin_panel') }}" class="p-2 -ml-2 rounded-full hover:bg-gray-100 transition-colors text-gray-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
        </a>
        <h1 class="text-2xl font-bold text-gray-900">会员系统设置</h1>
    </div>

    <div class="glass rounded-3xl overflow-hidden p-8 space-y-6">
        <form method="post" class="space-y-6">
            <!-- Enable/Disable Switch -->
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-medium text-gray-900">启用会员系统</h3>
                    <p class="text-sm text-gray-500">启用后，用户可以购买会员资格。</p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" name="enabled" class="sr-only peer" {% if settings.enabled %}checked{% endif %}>
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pumpkin-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pumpkin-500"></div>
                </label>
            </div>

            <div class="border-t border-gray-100"></div>

            <!-- Membership Price -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="price_usd" class="block text-sm font-medium text-gray-700 mb-2">价格 (USD)</label>
                    <input type="number" id="price_usd" name="price_usd" step="0.01" min="0.01" value="{{ settings.price_usd }}" class="w-full rounded-xl border border-gray-300 px-4 py-2 focus:border-pumpkin-500 focus:ring-pumpkin-500">
                    <p class="text-xs text-gray-500 mt-1">每月会员订阅价格</p>
                </div>

                <div>
                    <label for="duration_days" class="block text-sm font-medium text-gray-700 mb-2">有效期 (天数)</label>
                    <input type="number" id="duration_days" name="duration_days" min="1" value="{{ settings.duration_days }}" class="w-full rounded-xl border border-gray-300 px-4 py-2 focus:border-pumpkin-500 focus:ring-pumpkin-500">
                    <p class="text-xs text-gray-500 mt-1">单次购买的会员有效天数</p>
                </div>
            </div>

            <div class="border-t border-gray-100"></div>

            <!-- Payhip Configuration -->
            <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-4">
                <h3 class="text-sm font-semibold text-blue-900 mb-2">Payhip 配置说明</h3>
                <ul class="text-sm text-blue-800 space-y-1">
                    <li>• 访问 <a href="https://payhip.com" target="_blank" class="underline">Payhip</a> 获取 API Key</li>
                    <li>• 在 Payhip 创建一个产品用于会员订阅</li>
                    <li>• 复制产品ID和API Key到下面的字段</li>
                    <li>• 配置 Webhook URL: <code class="text-xs bg-white px-2 py-1 rounded">{{ request.host_url }}api/membership/webhook/payhip</code></li>
                </ul>
            </div>

            <div class="space-y-4">
                <div>
                    <label for="payhip_api_key" class="block text-sm font-medium text-gray-700 mb-2">Payhip API Key</label>
                    <input type="password" id="payhip_api_key" name="payhip_api_key" value="{{ settings.payhip_api_key }}" class="w-full rounded-xl border border-gray-300 px-4 py-2 focus:border-pumpkin-500 focus:ring-pumpkin-500" placeholder="您的 Payhip API Key">
                    <p class="text-xs text-gray-500 mt-1">保密 - 用于验证支付和 webhook</p>
                </div>

                <div>
                    <label for="payhip_product_id" class="block text-sm font-medium text-gray-700 mb-2">Payhip 产品 ID</label>
                    <input type="text" id="payhip_product_id" name="payhip_product_id" value="{{ settings.payhip_product_id }}" class="w-full rounded-xl border border-gray-300 px-4 py-2 focus:border-pumpkin-500 focus:ring-pumpkin-500" placeholder="您的产品ID">
                    <p class="text-xs text-gray-500 mt-1">从 Payhip 产品列表中复制</p>
                </div>
            </div>

            <div class="flex justify-end gap-3">
                <a href="{{ url_for('admin.admin_panel') }}" class="px-6 py-2.5 bg-gray-200 text-gray-900 font-bold rounded-xl hover:bg-gray-300 transition-colors">
                    取消
                </a>
                <button type="submit" class="px-6 py-2.5 bg-gray-900 text-white font-bold rounded-xl hover:bg-black transition-colors shadow-lg shadow-gray-900/20">
                    保存设置
                </button>
            </div>
        </form>
    </div>

    <!-- Test Section -->
    <div class="mt-8 glass rounded-3xl overflow-hidden p-8">
        <h2 class="text-xl font-bold text-gray-900 mb-4">快速操作</h2>
        <p class="text-sm text-gray-600 mb-4">可以手动为用户设置或取消会员资格：</p>
        
        <div class="space-y-3">
            <div class="flex gap-2">
                <input type="text" id="test_username" placeholder="输入用户名" class="flex-1 rounded-xl border border-gray-300 px-4 py-2 focus:border-pumpkin-500 focus:ring-pumpkin-500">
                <input type="number" id="test_days" placeholder="天数" value="30" min="1" max="3650" class="w-24 rounded-xl border border-gray-300 px-4 py-2 focus:border-pumpkin-500 focus:ring-pumpkin-500">
                <button type="button" onclick="setMember()" class="px-4 py-2 bg-green-600 text-white font-bold rounded-xl hover:bg-green-700 transition-colors">
                    设为会员
                </button>
            </div>
            <div class="flex gap-2">
                <input type="text" id="revoke_username" placeholder="输入用户名" class="flex-1 rounded-xl border border-gray-300 px-4 py-2 focus:border-pumpkin-500 focus:ring-pumpkin-500">
                <button type="button" onclick="revokeMember()" class="px-4 py-2 bg-red-600 text-white font-bold rounded-xl hover:bg-red-700 transition-colors">
                    取消会员
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function setMember() {
    const username = document.getElementById('test_username').value.trim();
    const days = parseInt(document.getElementById('test_days').value) || 30;
    
    if (!username) {
        alert('请输入用户名');
        return;
    }
    
    fetch(`/admin/membership/set_member/${encodeURIComponent(username)}/${days}`, {
        method: 'POST'
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert('✓ ' + data.message);
            document.getElementById('test_username').value = '';
        } else {
            alert('✗ ' + (data.error || '操作失败'));
        }
    })
    .catch(e => alert('错误: ' + e.message));
}

function revokeMember() {
    const username = document.getElementById('revoke_username').value.trim();
    
    if (!username) {
        alert('请输入用户名');
        return;
    }
    
    if (!confirm(`确认取消 ${username} 的会员资格？`)) {
        return;
    }
    
    fetch(`/admin/membership/revoke_member/${encodeURIComponent(username)}`, {
        method: 'POST'
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert('✓ ' + data.message);
            document.getElementById('revoke_username').value = '';
        } else {
            alert('✗ ' + (data.error || '操作失败'));
        }
    })
    .catch(e => alert('错误: ' + e.message));
}
</script>
{% endblock %}
