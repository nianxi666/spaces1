{% extends "layout.html" %}
{% block title %}订单管理 - 管理面板{% endblock %}
{% block content %}
<div class="max-w-6xl mx-auto pb-12">
    <!-- Header -->
    <div class="flex items-center gap-4 mb-6">
        <a href="{{ url_for('admin.admin_panel') }}" class="p-2 -ml-2 rounded-full hover:bg-gray-100 transition-colors text-gray-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
        </a>
        <h1 class="text-2xl font-bold text-gray-900">订单管理</h1>
    </div>

    <!-- Statistics -->
    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">
        <div class="glass rounded-2xl p-4 text-center">
            <div class="text-3xl font-bold text-gray-900">{{ stats.total_orders }}</div>
            <div class="text-sm text-gray-500 mt-1">总订单数</div>
        </div>
        <div class="glass rounded-2xl p-4 text-center">
            <div class="text-3xl font-bold text-orange-500">{{ stats.unpaid }}</div>
            <div class="text-sm text-gray-500 mt-1">未支付</div>
        </div>
        <div class="glass rounded-2xl p-4 text-center">
            <div class="text-3xl font-bold text-green-500">{{ stats.paid }}</div>
            <div class="text-sm text-gray-500 mt-1">已支付</div>
        </div>
        <div class="glass rounded-2xl p-4 text-center">
            <div class="text-3xl font-bold text-gray-500">{{ stats.cancelled }}</div>
            <div class="text-sm text-gray-500 mt-1">已取消</div>
        </div>
        <div class="glass rounded-2xl p-4 text-center">
            <div class="text-3xl font-bold text-red-500">{{ stats.expired }}</div>
            <div class="text-sm text-gray-500 mt-1">已过期</div>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="glass rounded-2xl p-6 mb-8">
        <h2 class="text-lg font-bold text-gray-900 mb-4">筛选</h2>
        <div class="flex flex-wrap gap-2">
            <a href="{{ url_for('admin.manage_orders') }}" 
               class="px-4 py-2 rounded-lg transition-colors {% if not filter_status %}bg-gray-900 text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
                全部
            </a>
            <a href="{{ url_for('admin.manage_orders', status='unpaid') }}" 
               class="px-4 py-2 rounded-lg transition-colors {% if filter_status == 'unpaid' %}bg-orange-500 text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
                未支付
            </a>
            <a href="{{ url_for('admin.manage_orders', status='paid') }}" 
               class="px-4 py-2 rounded-lg transition-colors {% if filter_status == 'paid' %}bg-green-500 text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
                已支付
            </a>
            <a href="{{ url_for('admin.manage_orders', status='cancelled') }}" 
               class="px-4 py-2 rounded-lg transition-colors {% if filter_status == 'cancelled' %}bg-gray-700 text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
                已取消
            </a>
            <a href="{{ url_for('admin.manage_orders', status='expired') }}" 
               class="px-4 py-2 rounded-lg transition-colors {% if filter_status == 'expired' %}bg-red-500 text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
                已过期
            </a>
        </div>
    </div>

    <!-- Orders Table -->
    <div class="glass rounded-2xl overflow-hidden">
        <table class="w-full">
            <thead>
                <tr class="border-b border-gray-200 bg-gray-50">
                    <th class="px-6 py-3 text-left text-sm font-bold text-gray-700">订单ID</th>
                    <th class="px-6 py-3 text-left text-sm font-bold text-gray-700">用户</th>
                    <th class="px-6 py-3 text-left text-sm font-bold text-gray-700">状态</th>
                    <th class="px-6 py-3 text-left text-sm font-bold text-gray-700">创建时间</th>
                    <th class="px-6 py-3 text-left text-sm font-bold text-gray-700">过期时间</th>
                    <th class="px-6 py-3 text-left text-sm font-bold text-gray-700">支付时间</th>
                    <th class="px-6 py-3 text-right text-sm font-bold text-gray-700">操作</th>
                </tr>
            </thead>
            <tbody>
                {% if orders %}
                    {% for order in orders %}
                    <tr class="border-b border-gray-100 hover:bg-gray-50 transition-colors">
                        <td class="px-6 py-4 text-sm font-mono text-gray-700">
                            {{ order.order_id[:8] }}...
                            <div class="text-xs text-gray-500 mt-1">{{ order.order_id }}</div>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-700">
                            <strong>{{ order.username }}</strong>
                        </td>
                        <td class="px-6 py-4 text-sm">
                            {% if order.status == 'unpaid' %}
                                <span class="px-3 py-1 rounded-full text-white bg-orange-500">未支付</span>
                            {% elif order.status == 'paid' %}
                                <span class="px-3 py-1 rounded-full text-white bg-green-500">已支付</span>
                            {% elif order.status == 'cancelled' %}
                                <span class="px-3 py-1 rounded-full text-white bg-gray-500">已取消</span>
                            {% elif order.status == 'expired' %}
                                <span class="px-3 py-1 rounded-full text-white bg-red-500">已过期</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-700">
                            {{ order.created_at[:16].replace('T', ' ') if order.created_at else '-' }}
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-700">
                            {{ order.expires_at[:16].replace('T', ' ') if order.expires_at else '-' }}
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-700">
                            {{ order.paid_at[:16].replace('T', ' ') if order.paid_at else '-' }}
                        </td>
                        <td class="px-6 py-4 text-sm text-right">
                            <div class="flex justify-end gap-2">
                                {% if order.status == 'unpaid' %}
                                    <button onclick="markOrderPaid('{{ order.order_id }}')" 
                                            class="px-3 py-1 bg-green-500 text-white rounded-lg text-xs font-bold hover:bg-green-600 transition-colors">
                                        标记支付
                                    </button>
                                    <button onclick="cancelOrder('{{ order.order_id }}')" 
                                            class="px-3 py-1 bg-red-500 text-white rounded-lg text-xs font-bold hover:bg-red-600 transition-colors">
                                        取消
                                    </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="7" class="px-6 py-12 text-center text-gray-500">
                            <p>暂无订单</p>
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<script>
function markOrderPaid(orderId) {
    if (!confirm('确定要标记此订单为已支付吗？')) return;
    
    fetch(`/admin/orders/${orderId}/mark-paid`, {
        method: 'POST'
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('错误: ' + data.error);
        }
    })
    .catch(e => alert('请求失败: ' + e));
}

function cancelOrder(orderId) {
    if (!confirm('确定要取消此订单吗？')) return;
    
    fetch(`/admin/orders/${orderId}/cancel`, {
        method: 'POST'
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('错误: ' + data.error);
        }
    })
    .catch(e => alert('请求失败: ' + e));
}
</script>
{% endblock %}
