{% extends "layout.html" %}
{% block title %}升级 Pro 会员 - 南瓜AI{% endblock %}
{% block content %}
<div class="max-w-2xl mx-auto pb-12">
    <div class="flex items-center gap-4 mb-6">
        <a href="{{ url_for('main.profile') }}" class="p-2 -ml-2 rounded-full hover:bg-gray-100 transition-colors text-gray-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
        </a>
        <h1 class="text-2xl font-bold text-gray-900">{% if payment_settings.enabled %}升级 Pro 会员{% else %}申请 Pro 会员{% endif %}</h1>
    </div>

    <div class="glass rounded-3xl overflow-hidden p-8 space-y-8">

        {% if payment_settings.enabled %}
            <!-- Payhip Payment Mode -->
            <div class="text-center">
                <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-pumpkin-100 text-pumpkin-600 mb-4">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                </div>
                <h2 class="text-3xl font-extrabold text-gray-900 mb-2">解锁 Pro 会员特权</h2>
                <p class="text-lg text-gray-600 mb-8">获得更快的 GPU 响应速度、专属客服支持以及更多高级功能。</p>

                <div class="bg-gray-50 rounded-2xl p-6 border border-gray-100 mb-8 text-left">
                    <ul class="space-y-4">
                        <li class="flex items-center">
                            <svg class="w-5 h-5 text-green-500 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                            <span class="text-gray-700">优先队列，极速生成</span>
                        </li>
                        <li class="flex items-center">
                            <svg class="w-5 h-5 text-green-500 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                            <span class="text-gray-700">解锁高性能 H100/L40S GPU</span>
                        </li>
                        <li class="flex items-center">
                            <svg class="w-5 h-5 text-green-500 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                            <span class="text-gray-700">更长的单次运行时间限制</span>
                        </li>
                    </ul>
                </div>

                <div class="flex flex-col items-center gap-4">
                    <a href="{{ payment_settings.product_link }}?checkout_custom_variables[username]={{ user.username }}"
                       target="_blank"
                       onclick="openPaymentConfirmModal()"
                       class="inline-flex items-center justify-center px-8 py-4 text-lg font-bold text-white bg-gradient-to-r from-pumpkin-500 to-rose-500 rounded-xl hover:shadow-lg hover:from-pumpkin-600 hover:to-rose-600 transition-all transform hover:-translate-y-1 active:scale-95 w-full sm:w-auto">
                        <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>
                        立即支付 $5 / 30天
                    </a>
                    <p class="text-xs text-gray-400">点击按钮将跳转至 Payhip 安全支付页面。支付成功后，您的会员时长将自动增加 30 天。</p>
                </div>

                <div class="border-t border-gray-100 my-6"></div>

                <!-- License Key Redemption -->
                <div class="text-center">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">已有激活码?</h3>
                    <div class="flex max-w-sm mx-auto gap-2">
                        <input type="text" id="license-key-input" placeholder="输入 Payhip 激活码 (License Key)" class="flex-1 rounded-xl border-gray-300 shadow-sm focus:border-pumpkin-500 focus:ring-pumpkin-500 px-4 py-2 text-center uppercase font-mono">
                        <button onclick="redeemLicenseKey()" id="redeem-btn" class="bg-gray-900 text-white px-4 py-2 rounded-xl hover:bg-black transition-colors font-medium whitespace-nowrap">
                            兑换
                        </button>
                    </div>
                    <p id="redeem-msg" class="text-xs mt-2 h-4"></p>
                </div>
            </div>

            <script>
            async function redeemLicenseKey() {
                const input = document.getElementById('license-key-input');
                const btn = document.getElementById('redeem-btn');
                const msg = document.getElementById('redeem-msg');
                const key = input.value.trim();

                if (!key) {
                    msg.textContent = '请输入激活码';
                    msg.className = 'text-xs mt-2 h-4 text-red-500';
                    return;
                }

                btn.disabled = true;
                btn.textContent = '验证中...';
                msg.textContent = '';

                try {
                    const response = await fetch('/api/payment/redeem_license', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ license_key: key })
                    });
                    const data = await response.json();

                    if (data.success) {
                        msg.textContent = '激活成功！正在刷新...';
                        msg.className = 'text-xs mt-2 h-4 text-green-600';
                        setTimeout(() => window.location.reload(), 1500);
                    } else {
                        msg.textContent = data.error || '激活失败';
                        msg.className = 'text-xs mt-2 h-4 text-red-500';
                        btn.disabled = false;
                        btn.textContent = '兑换';
                    }
                } catch (e) {
                    msg.textContent = '请求出错，请重试';
                    msg.className = 'text-xs mt-2 h-4 text-red-500';
                    btn.disabled = false;
                    btn.textContent = '兑换';
                }
            }
            </script>

            <!-- Payment Confirmation Modal -->
            <div id="payment-confirm-modal" class="fixed inset-0 z-[100] hidden items-center justify-center p-4" style="background-color: rgba(0,0,0,0.4); backdrop-filter: blur(4px);">
                <div class="bg-white rounded-3xl shadow-2xl w-full max-w-sm p-6 animate-fade-in-up text-center">
                    <div class="mb-4 text-pumpkin-500 flex justify-center">
                        <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </div>
                    <h3 class="text-xl font-bold text-gray-900 mb-2">等待支付完成</h3>
                    <p class="text-sm text-gray-500 mb-6">请在新打开的页面完成支付。支付成功后，请点击下方按钮以刷新您的会员状态。</p>

                    <div class="space-y-3">
                        <button onclick="checkPaymentStatus()" id="check-payment-btn" class="w-full px-4 py-3 bg-gray-900 text-white rounded-xl font-bold hover:bg-black transition-colors flex justify-center items-center">
                            <span>我已完成支付</span>
                            <svg id="check-loading" class="hidden animate-spin ml-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </button>
                        <button onclick="document.getElementById('payment-confirm-modal').classList.add('hidden')" class="w-full px-4 py-2 text-gray-500 font-medium hover:text-gray-700 transition-colors">稍后再试</button>
                    </div>
                    <p id="check-result-msg" class="text-xs mt-3 h-4"></p>
                </div>
            </div>

            <script>
            function openPaymentConfirmModal() {
                document.getElementById('payment-confirm-modal').classList.remove('hidden');
                document.getElementById('payment-confirm-modal').classList.add('flex');
            }

            async function checkPaymentStatus() {
                const btn = document.getElementById('check-payment-btn');
                const loading = document.getElementById('check-loading');
                const msg = document.getElementById('check-result-msg');
                const btnText = btn.querySelector('span');

                btn.disabled = true;
                btnText.textContent = '查询中...';
                loading.classList.remove('hidden');
                msg.textContent = '';
                msg.className = 'text-xs mt-3 h-4';

                try {
                    const response = await fetch('/api/payment/check_status', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    const data = await response.json();

                    if (data.success && data.paid) {
                        msg.textContent = '支付成功！正在刷新...';
                        msg.classList.add('text-green-600');
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        msg.textContent = '尚未查询到最新订单，请稍等片刻再试。';
                        msg.classList.add('text-red-500');
                        btn.disabled = false;
                        btnText.textContent = '我已完成支付';
                        loading.classList.add('hidden');
                    }
                } catch (e) {
                    msg.textContent = '查询出错，请重试';
                    msg.classList.add('text-red-500');
                    btn.disabled = false;
                    btnText.textContent = '我已完成支付';
                    loading.classList.add('hidden');
                }
            }
            </script>

        {% else %}
            <!-- Manual Submission Mode (Original) -->
            {% if user.pro_submission_status == 'pending' %}
            <div class="bg-blue-50 border border-blue-100 rounded-xl p-4 flex gap-3">
                <svg class="w-6 h-6 text-blue-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <div>
                    <h3 class="font-bold text-blue-800">审核中</h3>
                    <p class="text-sm text-blue-600 mt-1">您的申请已提交，管理员正在审核中。请耐心等待。</p>
                </div>
            </div>
            {% elif user.pro_submission_status == 'rejected' %}
            <div class="bg-red-50 border border-red-100 rounded-xl p-4 flex gap-3">
                <svg class="w-6 h-6 text-red-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <div>
                    <h3 class="font-bold text-red-800">申请未通过</h3>
                    <p class="text-sm text-red-600 mt-1">很遗憾，您的申请未通过审核。您可以重新完成任务并再次提交。</p>
                </div>
            </div>
            {% endif %}

            <!-- Task Description -->
            <div class="prose prose-pumpkin max-w-none">
                <h3 class="text-lg font-bold text-gray-900">任务说明</h3>
                <div class="text-gray-600 mt-2">
                    {{ pro_settings.task_description | safe }}
                </div>
            </div>

            <div class="border-t border-gray-100"></div>

            <!-- Submission Form -->
            <form method="post" class="space-y-4">
                <div>
                    <label for="submission_link" class="block text-sm font-medium text-gray-700 mb-2">任务完成链接</label>
                    <input type="url" id="submission_link" name="submission_link" placeholder="https://" required
                           class="w-full rounded-xl border-gray-300 shadow-sm focus:border-pumpkin-500 focus:ring-pumpkin-500 px-4 py-3">
                    <p class="text-xs text-gray-500 mt-2">请填写您完成任务后的证明链接。</p>
                </div>

                <button type="submit" class="w-full py-3 px-6 bg-gradient-to-r from-pumpkin-500 to-rose-500 text-white font-bold rounded-xl hover:shadow-lg hover:from-pumpkin-600 hover:to-rose-600 transition-all transform active:scale-95">
                    提交申请
                </button>
            </form>
        {% endif %}
    </div>
</div>
{% endblock %}
