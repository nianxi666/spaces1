# 客户信息查询功能说明

## ✅ 可以查询客户信息

虽然 Payhip API 没有专门的 `/api/v1/customers` 端点，但**可以**通过以下端点获取客户信息：

### API 端点

1. **License Keys API** (推荐)
   ```
   GET /api/v1/license_keys
   ```

2. **Sales API**
   ```
   GET /api/v1/sales
   ```

## 📊 返回的客户信息

从 API 响应中可以提取：

| 字段 | 说明 | 示例 |
|------|------|------|
| **order_id** | 订单 ID | `LWRwLk8Pza` |
| **email** | 客户邮箱 | `customer@example.com` |
| **username** | 用户名（自定义变量） | `testuser` |
| **product** | 产品名称 | `pumpkinai-pro` |
| **date** | 购买日期 | `2025-12-06` |
| **amount** | 金额 | `0.00` |
| **currency** | 货币 | `USD` |

## 🎯 新增功能

我已经在"测试 Payhip API"功能中添加了**自动提取客户信息**的功能。

### 使用步骤

#### 第 1 步：配置正确的 API Key

1. 访问 https://payhip.com/account/api
2. 复制 API Key（格式：`payhip_live_xxx...`）
3. 粘贴到"Payhip API Key"字段
4. 保存设置

#### 第 2 步：测试 API

点击"测试 Payhip API（尝试多种认证方式）"按钮

#### 第 3 步：查看客户列表

如果 API Key 正确，系统会自动显示：

```
✓ 成功的方法：
• Official: /api/v1/license_keys (recommended)

📧 找到 5 个客户/订单：

订单 ID         邮箱                          用户名         产品              日期
LWRwLk8Pza     sjjshsheueue                  testuser1     pumpkinai-pro    2025-12-06
KzyO74ekGX     isisjsjsa@gmail.com          testuser2     pumpkinai-pro    2025-12-06
2GZxenZ6zp     3221226810@outlook.com       testuser3     pumpkinai-pro    2025-12-06
yBbje3lvBD     3425354803@qq.com            testuser4     pumpkinai-pro    2025-12-05
LWRwL28vza     2198644948@qq.com            testuser5     pumpkinai-pro    2025-12-05

提示：绿色背景表示已正确传递用户名，可以直接使用批量激活功能。
```

## 🎨 视觉标识

- ✅ **绿色背景**：订单包含用户名，可以直接激活
- ⚠️ **白色背景 + 红色警告**：订单未传递用户名

## 💡 实用功能

### 自动匹配用户名

如果您的支付链接正确包含了用户名：
```
https://payhip.com/b/gLQxR?checkout_custom_variables[username]=testuser
```

系统会自动提取并显示用户名，方便您使用批量激活功能。

### 直接复制到批量激活

看到客户列表后，可以快速准备批量激活数据：

```
testuser1,LWRwLk8Pza,sjjshsheueue
testuser2,KzyO74ekGX,isisjsjsa@gmail.com
testuser3,2GZxenZ6zp,3221226810@outlook.com
testuser4,yBbje3lvBD,3425354803@qq.com
testuser5,LWRwL28vza,2198644948@qq.com
```

## 🔍 技术细节

### 数据提取逻辑

系统会智能提取以下信息：

1. **订单 ID**：从 `id`、`order_id`、`sale_id` 字段
2. **邮箱**：从 `email` 字段
3. **用户名**：从 `checkout_custom_variables.username`
4. **产品**：从 `product_name` 或 `product` 字段
5. **日期**：从 `created_at` 或 `date` 字段
6. **金额**：从 `price`、`amount` 或 `total` 字段

### 兼容多种数据格式

系统自动处理：
- JSON 对象格式
- 数组格式
- 字符串化的 JSON
- 不同的字段命名

## ⚠️ 注意事项

### 前提条件

1. **必须有正确的 API Key**
   - 格式：`payhip_live_xxx...` 或 `payhip_test_xxx...`
   - 不是 Webhook Secret

2. **账号必须支持 API**
   - 某些 Payhip 账号可能不提供 API 访问
   - 可能需要特定的付费计划

### 用户名传递

如果客户列表显示"⚠️ 未传递"：

- 说明支付链接没有包含 `checkout_custom_variables[username]`
- 需要通过其他方式（如邮箱）确认用户身份
- 仍然可以手动激活，但需要您手动匹配

## 🎉 优势

### 1. 快速查看所有订单

一键查看所有客户和订单信息，无需在 Payhip 后台查找。

### 2. 自动提取用户名

如果正确配置了支付链接，用户名会自动显示。

### 3. 方便批量处理

直接看到完整的客户信息，方便复制到批量激活功能。

### 4. 视觉化提示

通过颜色区分有无用户名，一目了然。

## 📋 完整工作流程

### 流程 1：理想情况（有 API Key + 正确传递用户名）

```
1. 配置 Payhip API Key
   ↓
2. 点击"测试 Payhip API"
   ↓
3. 查看客户列表（包含用户名）
   ↓
4. 复制到批量激活
   ↓
5. 一键激活所有订单
   ✅ 完成
```

### 流程 2：没有 API Key

```
1. 从 Payhip 后台查看订单
   ↓
2. 手动记录订单 ID 和邮箱
   ↓
3. 匹配用户名
   ↓
4. 使用批量激活
   ✅ 完成
```

### 流程 3：有 API Key 但未传递用户名

```
1. 点击"测试 Payhip API"
   ↓
2. 查看客户列表（显示邮箱和订单 ID）
   ↓
3. 通过邮箱匹配用户名
   ↓
4. 使用批量激活
   ✅ 完成
```

## 📚 相关文档

- **快速修复指南.md** - API Key 配置说明
- **根据官方文档更新.md** - API 端点详情
- **批量激活指南.md** - 批量激活使用方法

## 🎯 总结

### ✅ 可以查询客户信息

- 通过 License Keys API 获取
- 包含邮箱、订单 ID、用户名等
- 界面自动显示和格式化

### 🚀 立即可用

- 配置正确的 API Key 后即可使用
- 自动提取和显示客户信息
- 方便快速激活订单

### 💡 即使没有 API Key

- 仍然可以使用批量激活功能
- 手动输入订单信息即可
- 功能完全不受影响

---

**现在就去配置 API Key 并测试吧！** 🎉
